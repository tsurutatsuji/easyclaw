const express = require('express');
const { execSync } = require('child_process');
const crypto = require('crypto');
const fs = require('fs');
const path = require('path');
const Database = require('better-sqlite3');
const bcrypt = require('bcryptjs');
const jwt = require('jsonwebtoken');
const app = express();
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(express.static('/home/ubuntu/easyclaw-api/public'));
app.get("/", (req, res) => { res.sendFile("/home/ubuntu/easyclaw-api/public/lp.html"); });
const JWT_SECRET = crypto.randomBytes(32).toString('hex');
const db = new Database('/home/ubuntu/easyclaw-api/users.db');
db.exec('CREATE TABLE IF NOT EXISTS users (id INTEGER PRIMARY KEY, email TEXT UNIQUE, password TEXT, createdAt TEXT)');
db.exec('CREATE TABLE IF NOT EXISTS deployments (id INTEGER PRIMARY KEY, userId TEXT, email TEXT, port INTEGER, model TEXT, status TEXT, createdAt TEXT)');
const UD = '/opt/easyclaw/users';
const OC = '/home/ubuntu/.npm-global/bin/openclaw';
function auth(req, res, next) { const t = req.headers.authorization; if (!t) return res.status(401).json({error:'ログイン必須'}); try { req.user = jwt.verify(t.replace('Bearer ',''), JWT_SECRET); next(); } catch(e) { res.status(401).json({error:'再ログインしてください'}); } }
app.post('/api/register', (req, res) => { try { const {email,password}=req.body; if(!email||!password) return res.status(400).json({error:'メールとパスワードを入力'}); if(password.length<6) return res.status(400).json({error:'パスワードは6文字以上'}); const hash=bcrypt.hashSync(password,10); db.prepare('INSERT INTO users (email,password,createdAt) VALUES (?,?,?)').run(email,hash,new Date().toISOString()); const token=jwt.sign({email},JWT_SECRET,{expiresIn:'7d'}); res.json({success:true,token,email}); } catch(e) { if(e.message.includes('UNIQUE')) return res.status(400).json({error:'登録済みメール'}); res.status(500).json({error:e.message}); } });
app.post('/api/login', (req, res) => { const {email,password}=req.body; if(!email||!password) return res.status(400).json({error:'メールとパスワードを入力'}); const user=db.prepare('SELECT * FROM users WHERE email=?').get(email); if(!user||!bcrypt.compareSync(password,user.password)) return res.status(401).json({error:'メールまたはパスワードが違います'}); const token=jwt.sign({email},JWT_SECRET,{expiresIn:'7d'}); res.json({success:true,token,email}); });
app.post('/api/deploy', auth, (req, res) => { try { const {userId,apiProvider,apiKey,model,discordToken,discordUserId}=req.body; if(!userId||!apiKey||!discordToken||!discordUserId) return res.status(400).json({error:'全項目入力必須'}); const users=fs.existsSync(UD)?fs.readdirSync(UD):[]; const port=20001+users.length; const od=path.join(UD,userId,'.openclaw'); const ad=path.join(od,'agents/main/agent'); const cd=path.join(od,'credentials'); const wd=path.join(od,'workspace'); fs.mkdirSync(ad,{recursive:true}); fs.mkdirSync(cd,{recursive:true}); fs.mkdirSync(wd,{recursive:true}); const gt=crypto.randomBytes(24).toString('hex'); fs.writeFileSync(path.join(ad,'auth.json'),JSON.stringify({[apiProvider]:{type:'api_key',key:apiKey}})); fs.writeFileSync(path.join(ad,'auth-profiles.json'),JSON.stringify({version:1,profiles:{[apiProvider+':default']:{type:'api_key',provider:apiProvider,key:apiKey}},lastGood:{[apiProvider]:apiProvider+':default'}})); fs.writeFileSync(path.join(od,'openclaw.json'),JSON.stringify({auth:{profiles:{[apiProvider+':default']:{provider:apiProvider,mode:'api_key'}}},agents:{defaults:{model:{primary:model},workspace:wd,compaction:{mode:'safeguard'},maxConcurrent:4}},channels:{discord:{enabled:true,token:discordToken,groupPolicy:'allowlist',guilds:{}}},gateway:{port,mode:'local',bind:'loopback',auth:{mode:'token',token:gt}},plugins:{entries:{discord:{enabled:true}}}})); fs.writeFileSync(path.join(cd,'discord-allowFrom.json'),JSON.stringify({version:1,allowFrom:[discordUserId]})); execSync('chown -R ubuntu:ubuntu '+path.join(UD,userId)); const sn='easyclaw-'+userId; const sc='[Unit]\nDescription=EasyClaw - '+userId+'\nAfter=network.target\n\n[Service]\nType=simple\nUser=ubuntu\nEnvironment=OPENCLAW_CONFIG_PATH='+path.join(od,'openclaw.json')+'\nExecStart='+OC+' gateway --port '+port+' --allow-unconfigured\nRestart=always\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target'; fs.writeFileSync('/etc/systemd/system/'+sn+'.service',sc); execSync('systemctl daemon-reload'); execSync('systemctl enable '+sn); execSync('systemctl start '+sn); db.prepare('INSERT INTO deployments (userId,email,port,model,status,createdAt) VALUES (?,?,?,?,?,?)').run(userId,req.user.email,port,model,'active',new Date().toISOString()); res.json({success:true,message:'デプロイ完了',userId,port,model,discordUserId}); } catch(e) { res.status(500).json({error:e.message}); } });
app.get('/api/my-deployment', auth, (req,res) => { const dep=db.prepare('SELECT * FROM deployments WHERE email=?').get(req.user.email); if(!dep) return res.json({exists:false}); try { const s=execSync('systemctl is-active easyclaw-'+dep.userId).toString().trim(); res.json({exists:true,...dep,running:s==='active'}); } catch(e) { res.json({exists:true,...dep,running:false}); } });
app.post('/api/stop/:userId', auth, (req,res) => { try { execSync('systemctl stop easyclaw-'+req.params.userId); db.prepare('UPDATE deployments SET status=? WHERE userId=?').run('stopped',req.params.userId); res.json({message:'停止'}); } catch(e) { res.status(500).json({error:'失敗'}); } });
app.post('/api/delete/:userId', auth, (req,res) => { const u=req.params.userId; try { execSync('systemctl stop easyclaw-'+u); execSync('systemctl disable easyclaw-'+u); fs.unlinkSync('/etc/systemd/system/easyclaw-'+u+'.service'); execSync('systemctl daemon-reload'); execSync('rm -rf '+path.join(UD,u)); db.prepare('DELETE FROM deployments WHERE userId=?').run(u); res.json({message:'削除完了'}); } catch(e) { res.status(500).json({error:'失敗'}); } });
app.listen(3000,'0.0.0.0',()=>console.log('EasyClaw API running on port 3000'));
