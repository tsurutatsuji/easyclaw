<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>EasyClaw â€” ãƒ­ã‚°ã‚¤ãƒ³</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¦</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;450;500;600;700;800&family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=JetBrains+Mono:wght@300;400;500&family=Noto+Sans+JP:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
--black:#050505;--dark:#0a0a0a;--dark2:#111;--dark3:#1a1a1a;--dark4:#222;
--text:#e8e8e8;--text2:#888;--text3:#555;
--green:#00ff41;--green2:#00cc33;--greenDim:rgba(0,255,65,0.08);--greenGlow:rgba(0,255,65,0.15);
--accent:#e8562a;--accent2:#ff7040;
}
html{scroll-behavior:smooth}
body{font-family:'Inter','Noto Sans JP',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--black);color:var(--text);overflow-x:hidden;-webkit-font-smoothing:antialiased;min-height:100vh;display:flex;flex-direction:column}
::selection{background:var(--greenGlow);color:var(--green)}

#matrix-bg{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;opacity:.08;pointer-events:none}

nav{position:fixed;top:0;left:0;right:0;z-index:100;padding:14px 24px;display:flex;align-items:center;justify-content:space-between;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);background:rgba(5,5,5,0.75);border-bottom:1px solid rgba(255,255,255,0.03)}
.nav-logo{font-size:16px;font-weight:600;display:flex;align-items:center;gap:8px;letter-spacing:-.3px;text-decoration:none;color:var(--text)}
.nav-logo span{font-size:18px}
.nav-links a{color:var(--text2);font-size:13px;text-decoration:none;transition:color .2s;font-weight:400}
.nav-links a:hover{color:var(--text)}

.auth-container{position:relative;z-index:1;flex:1;display:flex;align-items:center;justify-content:center;padding:100px 20px 60px}

.auth-card{width:100%;max-width:420px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:20px;padding:40px 36px;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);animation:fadeUp .6s ease}

.auth-header{text-align:center;margin-bottom:36px}
.auth-header h1{font-family:'Playfair Display',serif;font-size:28px;font-weight:600;letter-spacing:-.5px;margin-bottom:8px}
.auth-header p{font-size:13px;color:var(--text2);font-weight:300;letter-spacing:.3px}

.form-group{margin-bottom:20px}
.form-label{display:block;font-size:11px;font-weight:500;color:var(--text2);margin-bottom:8px;letter-spacing:1px;text-transform:uppercase;font-family:'JetBrains Mono',monospace}
.form-input{width:100%;padding:14px 18px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none;transition:border-color .2s,box-shadow .2s}
.form-input:focus{border-color:rgba(0,255,65,0.3);box-shadow:0 0 0 3px rgba(0,255,65,0.05)}
.form-input::placeholder{color:var(--text3)}

.btn-primary{display:block;width:100%;padding:16px;border:none;border-radius:980px;font-size:15px;font-weight:500;cursor:pointer;background:var(--accent);color:#fff;font-family:inherit;letter-spacing:.3px;transition:all .25s;margin-top:8px}
.btn-primary:hover{background:var(--accent2);transform:translateY(-2px);box-shadow:0 8px 30px rgba(232,86,42,0.3)}
.btn-primary:disabled{opacity:0.5;cursor:not-allowed;transform:none;box-shadow:none}

.switch-link{text-align:center;margin-top:24px;font-size:13px;color:var(--text2)}
.switch-link a{color:var(--green);cursor:pointer;text-decoration:none;font-weight:500;transition:opacity .2s}
.switch-link a:hover{opacity:.8}

.alert{padding:14px 18px;border-radius:12px;font-size:13px;margin-bottom:20px;display:none;line-height:1.6}
.alert.error{display:block;background:rgba(248,113,113,0.08);border:1px solid rgba(248,113,113,0.2);color:#F87171}
.alert.success{display:block;background:rgba(0,255,65,0.05);border:1px solid rgba(0,255,65,0.15);color:var(--green)}

.otp-input{display:flex;justify-content:center;gap:8px;margin-bottom:24px}
.otp-input input{width:48px;height:56px;text-align:center;font-size:24px;font-weight:600;font-family:'JetBrains Mono',monospace;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:12px;color:var(--green);outline:none;transition:border-color .2s}
.otp-input input:focus{border-color:rgba(0,255,65,0.4);box-shadow:0 0 0 3px rgba(0,255,65,0.08)}

.resend-link{text-align:center;margin-top:16px;font-size:12px;color:var(--text3)}
.resend-link a{color:var(--text2);cursor:pointer;text-decoration:none;transition:color .2s}
.resend-link a:hover{color:var(--green)}

.help-note{background:rgba(0,255,65,0.03);border:1px solid rgba(0,255,65,0.1);border-radius:10px;padding:12px 16px;margin-bottom:20px;font-size:12px;color:var(--text2);line-height:1.7;display:flex;align-items:flex-start;gap:8px}
.help-note .icon{flex-shrink:0;font-size:14px}
.help-note a{color:var(--green);text-decoration:none;font-weight:500}
.help-note a:hover{text-decoration:underline}
.help-note code{font-family:'JetBrains Mono',monospace;font-size:11px;background:rgba(0,255,65,0.05);border:1px solid rgba(0,255,65,0.08);padding:0 4px;border-radius:3px;color:var(--green)}

.spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:spin .6s linear infinite;vertical-align:middle;margin-right:8px}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:none}}

@media(max-width:480px){
  .auth-card{padding:32px 24px;border-radius:16px}
  .auth-header h1{font-size:24px}
}
</style>
</head>
<body>
<canvas id="matrix-bg"></canvas>
<nav>
  <a href="/" class="nav-logo"><span>ğŸ¦</span> EasyClaw</a>
  <div class="nav-links"><a href="/">ãƒ›ãƒ¼ãƒ </a></div>
</nav>

<div class="auth-container">
  <!-- Login View -->
  <div class="auth-card" id="loginView">
    <div class="auth-header">
      <h1>Welcome Back</h1>
      <p>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ãƒ­ã‚°ã‚¤ãƒ³</p>
    </div>
    <div id="loginAlert" class="alert"></div>
    <div class="form-group">
      <label class="form-label">Email</label>
      <input type="email" id="loginEmail" class="form-input" placeholder="you@example.com" autocomplete="email">
    </div>
    <div class="form-group">
      <label class="form-label">Password</label>
      <input type="password" id="loginPassword" class="form-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" autocomplete="current-password">
    </div>
    <button class="btn-primary" id="loginBtn" onclick="doLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    <div class="switch-link">ã¯ã˜ã‚ã¦ã®æ–¹ã¯ <a onclick="showView('register')">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</a></div>
  </div>

  <!-- Register View -->
  <div class="auth-card" id="registerView" style="display:none">
    <div class="auth-header">
      <h1>Get Started</h1>
      <p>ç„¡æ–™ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ</p>
    </div>
    <div class="help-note">
      <span class="icon">ğŸ†“</span>
      <div>ç™»éŒ²ã¯å®Œå…¨ç„¡æ–™ã§ã™ã€‚ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã ã‘ã§å§‹ã‚ã‚‰ã‚Œã¾ã™ã€‚ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ä¸è¦ã€‚</div>
    </div>
    <div id="registerAlert" class="alert"></div>
    <div class="form-group">
      <label class="form-label">Email</label>
      <input type="email" id="registerEmail" class="form-input" placeholder="you@example.com" autocomplete="email">
    </div>
    <div class="form-group">
      <label class="form-label">Password</label>
      <input type="password" id="registerPassword" class="form-input" placeholder="6æ–‡å­—ä»¥ä¸Š" autocomplete="new-password">
    </div>
    <button class="btn-primary" id="registerBtn" onclick="doRegister()">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</button>
    <div class="switch-link">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã®æ–¹ã¯ <a onclick="showView('login')">ãƒ­ã‚°ã‚¤ãƒ³</a></div>
  </div>

  <!-- OTP View -->
  <div class="auth-card" id="otpView" style="display:none">
    <div class="auth-header">
      <h1>èªè¨¼ã‚³ãƒ¼ãƒ‰</h1>
      <p id="otpEmail">é€ä¿¡ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›</p>
    </div>
    <div class="help-note" id="otpHelpNote" style="display:none">
      <span class="icon">ğŸ’¡</span>
      <div>ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã¯ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãŒç„¡åŠ¹ã®ãŸã‚ã€èªè¨¼ã‚³ãƒ¼ãƒ‰ã¯ã‚µãƒ¼ãƒãƒ¼ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆã‚¿ãƒ¼ãƒŸãƒŠãƒ«ï¼‰ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br><code>node server.js</code> ã‚’å®Ÿè¡Œã—ãŸã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>
    </div>
    <div id="otpAlert" class="alert"></div>
    <div class="otp-input" id="otpInputs">
      <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" autocomplete="one-time-code">
      <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]">
      <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]">
      <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]">
      <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]">
      <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]">
    </div>
    <button class="btn-primary" id="otpBtn" onclick="doVerifyOTP()">èªè¨¼ã™ã‚‹</button>
    <div class="resend-link">ã‚³ãƒ¼ãƒ‰ãŒå±Šã‹ãªã„å ´åˆ <a onclick="doResendOTP()">å†é€ä¿¡</a></div>
  </div>
</div>

<script>
let pendingEmail = "";

// Check existing token on load
(async function checkToken() {
  const token = localStorage.getItem("token");
  if (!token) return;
  try {
    const res = await fetch("/api/verify-token", { headers: { Authorization: "Bearer " + token } });
    const data = await res.json();
    if (data.valid) {
      if (data.setupCompleted) {
        location.href = "/chat.html";
      } else {
        location.href = "/setup.html";
      }
    } else {
      localStorage.removeItem("token");
      localStorage.removeItem("email");
    }
  } catch(e) {
    localStorage.removeItem("token");
    localStorage.removeItem("email");
  }
})();

function showView(view) {
  document.getElementById("loginView").style.display = view === "login" ? "block" : "none";
  document.getElementById("registerView").style.display = view === "register" ? "block" : "none";
  document.getElementById("otpView").style.display = view === "otp" ? "block" : "none";
  // Show OTP console help note (always show in local mode since Gmail is likely not configured)
  if (view === "otp") {
    document.getElementById("otpHelpNote").style.display = "flex";
  }
}

function showAlert(id, msg, type) {
  const el = document.getElementById(id);
  el.className = "alert " + type;
  el.textContent = msg;
}

async function doLogin() {
  const email = document.getElementById("loginEmail").value.trim();
  const password = document.getElementById("loginPassword").value;
  if (!email || !password) return showAlert("loginAlert", "ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "error");
  const btn = document.getElementById("loginBtn");
  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>ãƒ­ã‚°ã‚¤ãƒ³ä¸­...';
  try {
    const res = await fetch("/api/login", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ email, password }) });
    const data = await res.json();
    if (data.success && data.needVerify) {
      pendingEmail = data.email;
      document.getElementById("otpEmail").textContent = data.email + " ã«èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸ";
      showView("otp");
      setupOTPInputs();
    } else if (data.success && data.token) {
      localStorage.setItem("token", data.token);
      localStorage.setItem("email", data.email);
      // Check setup status
      const vRes = await fetch("/api/verify-token", { headers: { Authorization: "Bearer " + data.token } });
      const vData = await vRes.json();
      location.href = vData.setupCompleted ? "/chat.html" : "/setup.html";
    } else {
      showAlert("loginAlert", data.error || "ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
    }
  } catch(e) { showAlert("loginAlert", "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ", "error"); }
  btn.disabled = false; btn.textContent = "ãƒ­ã‚°ã‚¤ãƒ³";
}

async function doRegister() {
  const email = document.getElementById("registerEmail").value.trim();
  const password = document.getElementById("registerPassword").value;
  if (!email || !password) return showAlert("registerAlert", "ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "error");
  if (password.length < 6) return showAlert("registerAlert", "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„", "error");
  const btn = document.getElementById("registerBtn");
  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>ä½œæˆä¸­...';
  try {
    const res = await fetch("/api/register", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ email, password }) });
    const data = await res.json();
    if (data.success && data.needVerify) {
      pendingEmail = data.email;
      document.getElementById("otpEmail").textContent = data.email + " ã«èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸ";
      showView("otp");
      setupOTPInputs();
    } else {
      showAlert("registerAlert", data.error || "ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
    }
  } catch(e) { showAlert("registerAlert", "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ", "error"); }
  btn.disabled = false; btn.textContent = "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ";
}

function setupOTPInputs() {
  const inputs = document.querySelectorAll("#otpInputs input");
  inputs.forEach((input, i) => {
    input.value = "";
    input.addEventListener("input", (e) => {
      if (e.target.value && i < inputs.length - 1) inputs[i + 1].focus();
      if (i === inputs.length - 1 && e.target.value) doVerifyOTP();
    });
    input.addEventListener("keydown", (e) => {
      if (e.key === "Backspace" && !e.target.value && i > 0) inputs[i - 1].focus();
    });
    input.addEventListener("paste", (e) => {
      e.preventDefault();
      const paste = (e.clipboardData || window.clipboardData).getData("text").replace(/\D/g, "").slice(0, 6);
      paste.split("").forEach((ch, j) => { if (inputs[j]) inputs[j].value = ch; });
      if (paste.length === 6) doVerifyOTP();
    });
  });
  inputs[0].focus();
}

async function doVerifyOTP() {
  const inputs = document.querySelectorAll("#otpInputs input");
  const code = Array.from(inputs).map(i => i.value).join("");
  if (code.length !== 6) return showAlert("otpAlert", "6æ¡ã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "error");
  const btn = document.getElementById("otpBtn");
  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>èªè¨¼ä¸­...';
  try {
    const res = await fetch("/api/verify-otp", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ email: pendingEmail, code }) });
    const data = await res.json();
    if (data.success && data.token) {
      localStorage.setItem("token", data.token);
      localStorage.setItem("email", data.email);
      location.href = "/setup.html";
    } else {
      showAlert("otpAlert", data.error || "èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
    }
  } catch(e) { showAlert("otpAlert", "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ", "error"); }
  btn.disabled = false; btn.textContent = "èªè¨¼ã™ã‚‹";
}

async function doResendOTP() {
  try {
    await fetch("/api/resend-otp", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ email: pendingEmail }) });
    showAlert("otpAlert", "èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’å†é€ä¿¡ã—ã¾ã—ãŸ", "success");
  } catch(e) { showAlert("otpAlert", "å†é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ", "error"); }
}

// Enter key support
document.addEventListener("keydown", (e) => {
  if (e.key !== "Enter") return;
  if (document.getElementById("loginView").style.display !== "none") doLogin();
  else if (document.getElementById("registerView").style.display !== "none") doRegister();
});

// Matrix rain
(function() {
  const c = document.getElementById("matrix-bg"), ctx = c.getContext("2d");
  function resize() { c.width = window.innerWidth; c.height = window.innerHeight; }
  resize(); window.addEventListener("resize", resize);
  const chars = "ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªã‚«ã‚­ã‚¯ã‚±ã‚³ã‚µã‚·ã‚¹ã‚»ã‚½ã‚¿ãƒãƒ„ãƒ†ãƒˆãƒŠãƒ‹ãƒŒãƒãƒãƒãƒ’ãƒ•ãƒ˜ãƒ›ãƒãƒŸãƒ ãƒ¡ãƒ¢ãƒ¤ãƒ¦ãƒ¨ãƒ©ãƒªãƒ«ãƒ¬ãƒ­ãƒ¯ãƒ²ãƒ³0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  const fontSize = 14, columns = Math.floor(window.innerWidth / fontSize);
  const drops = Array(columns).fill(1);
  function draw() {
    ctx.fillStyle = "rgba(5,5,5,0.15)";
    ctx.fillRect(0, 0, c.width, c.height);
    ctx.fillStyle = "#00ff41";
    ctx.font = fontSize + "px 'JetBrains Mono', monospace";
    for (let i = 0; i < drops.length; i++) {
      const text = chars[Math.floor(Math.random() * chars.length)];
      ctx.fillText(text, i * fontSize, drops[i] * fontSize);
      if (drops[i] * fontSize > c.height && Math.random() > 0.975) drops[i] = 0;
      drops[i]++;
    }
  }
  setInterval(draw, 45);
})();
</script>
</body>
</html>
