<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>EasyClaw Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&family=Noto+Sans+JP:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#1a1a1a;--bg2:#212121;--bg3:#2a2a2a;--bg4:#333;--text:#ececec;--text2:#a0a0a0;--text3:#666;--accent:#c47a2a;--accent2:#d4893a}
html,body{height:100%;font-family:'Inter','Noto Sans JP',-apple-system,sans-serif;background:var(--bg);color:var(--text);overflow:hidden;-webkit-font-smoothing:antialiased}
.app{display:flex;height:100vh;height:100dvh}

.sidebar{width:260px;min-width:260px;background:#151515;display:flex;flex-direction:column;border-right:1px solid rgba(255,255,255,0.04);z-index:20;transition:transform .25s}
.sb-top{padding:12px;display:flex;align-items:center;justify-content:space-between}
.sb-logo{font-size:14px;font-weight:600;display:flex;align-items:center;gap:6px}
.sb-logo span{color:var(--text2);font-size:11px;font-weight:400}
.sb-new{width:32px;height:32px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all .15s}
.sb-new:hover{background:var(--bg3);color:var(--text)}
.sb-sessions{flex:1;overflow-y:auto;padding:4px 8px}
.sb-sessions::-webkit-scrollbar{width:3px}
.sb-sessions::-webkit-scrollbar-thumb{background:#333;border-radius:3px}
.sb-label{font-size:10px;font-weight:500;color:var(--text3);padding:10px 8px 4px;text-transform:uppercase;letter-spacing:.8px}
.sb-item{padding:8px 10px;border-radius:8px;cursor:pointer;margin-bottom:1px;font-size:13px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;transition:all .1s}
.sb-item:hover{background:rgba(255,255,255,0.04);color:var(--text)}
.sb-item input{box-sizing:border-box}
.sb-item.active{background:rgba(255,255,255,0.06);color:var(--text)}
.sb-footer{padding:10px 12px;border-top:1px solid rgba(255,255,255,0.04)}
.sb-footer a{display:flex;align-items:center;gap:6px;color:var(--text3);font-size:12px;text-decoration:none;padding:6px 4px;border-radius:6px}
.sb-footer a:hover{color:var(--text);background:rgba(255,255,255,0.04)}

.main{flex:1;display:flex;flex-direction:column;min-width:0}
.topbar{height:44px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;border-bottom:1px solid rgba(255,255,255,0.04);flex-shrink:0}
.tb-left{display:flex;align-items:center;gap:8px}
.menu-btn{display:none;background:none;border:none;color:var(--text2);cursor:pointer;padding:4px}
.menu-btn svg{width:18px;height:18px}
.tb-title{font-size:13px;font-weight:500;color:var(--text)}
.tb-right{display:flex;align-items:center;gap:6px}
.tb-status{display:flex;align-items:center;gap:4px;font-size:11px;color:var(--text3)}
.tb-dot{width:6px;height:6px;border-radius:50%;background:#22c55e}
.tb-dot.off{background:#ef4444}

.content-area{flex:1;display:flex;flex-direction:column;min-height:0}
.welcome{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 24px}
.welcome.hidden{display:none}
.w-icon{font-size:36px;margin-bottom:12px;opacity:.5}
.w-title{font-size:20px;font-weight:600;margin-bottom:4px;letter-spacing:-.3px}
.w-sub{font-size:14px;color:var(--text2);font-weight:300}

.messages{flex:1;overflow-y:auto;padding:20px 0;display:none}
.messages.show{display:block}
.messages::-webkit-scrollbar{width:5px}
.messages::-webkit-scrollbar-thumb{background:#333;border-radius:5px}

.msg-wrap{padding:16px 0}
.msg-wrap.assistant{background:rgba(255,255,255,0.015)}
.msg-inner{max-width:680px;margin:0 auto;padding:0 24px;display:flex;gap:12px}
.msg-wrap.user .msg-inner{flex-direction:row-reverse}
.msg-icon{width:24px;height:24px;border-radius:6px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:12px;margin-top:2px}
.msg-icon.u{background:var(--accent);color:#fff;font-weight:600;font-size:10px}
.msg-icon.a{background:var(--bg4);color:var(--accent);font-size:14px}
.msg-content{flex:1;min-width:0;font-size:14px;line-height:1.75;font-weight:400;color:var(--text)}
.msg-wrap.user .msg-content{text-align:left}
.msg-content p{margin-bottom:8px}.msg-content p:last-child{margin-bottom:0}
.msg-content strong{font-weight:600}
.msg-content code{font-family:'JetBrains Mono',monospace;font-size:12px;background:var(--bg4);padding:1px 5px;border-radius:4px}
.msg-content pre{background:#151515;border:1px solid rgba(255,255,255,0.06);border-radius:10px;padding:14px;margin:10px 0;overflow-x:auto;font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.6}
.msg-time{font-size:10px;color:var(--text3);margin-top:4px}
.msg-wrap.user .msg-time{text-align:right}

/* Claude-style input box */
.input-area{padding:12px 24px 16px;flex-shrink:0}
.input-box{max-width:680px;margin:0 auto;background:var(--bg3);border:1px solid rgba(255,255,255,0.08);border-radius:16px;overflow:hidden;transition:border-color .2s}
.input-box:focus-within{border-color:rgba(196,122,42,0.4)}
.input-box textarea{width:100%;min-height:44px;max-height:200px;background:transparent;border:none;padding:14px 18px 8px;color:var(--text);font-size:14px;font-family:inherit;resize:none;outline:none;line-height:1.5}
.input-box textarea::placeholder{color:var(--text3)}
.input-toolbar{display:flex;align-items:center;justify-content:space-between;padding:4px 8px 8px}
.input-toolbar-left{display:flex;align-items:center;gap:2px}
.input-toolbar-right{display:flex;align-items:center;gap:6px}
.tb-btn{width:32px;height:32px;border-radius:8px;border:none;background:transparent;color:var(--text3);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.tb-btn:hover{background:var(--bg4);color:var(--text2)}
.tb-btn svg{width:18px;height:18px}
.model-btn{display:flex;align-items:center;gap:3px;padding:4px 10px;border-radius:8px;border:none;background:transparent;color:var(--text3);cursor:pointer;font-size:12px;font-family:inherit;transition:all .15s}
.model-btn:hover{background:var(--bg4);color:var(--text2)}
.send-btn{width:32px;height:32px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.send-btn:hover{background:var(--accent2)}
.send-btn:disabled{opacity:.3;cursor:not-allowed}
.send-btn svg{width:16px;height:16px}

.file-preview{display:flex;gap:6px;padding:4px 12px;flex-wrap:wrap}
.file-tag{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;background:var(--bg4);border-radius:6px;font-size:11px;color:var(--text2)}
.file-tag .rm{cursor:pointer;opacity:.5;font-size:13px}.file-tag .rm:hover{opacity:1}

.typing-dots{display:inline-flex;gap:3px;padding:2px 0}
.typing-dots span{width:5px;height:5px;border-radius:50%;background:var(--text3);animation:pulse 1.4s infinite both}
.typing-dots span:nth-child(2){animation-delay:.2s}
.typing-dots span:nth-child(3){animation-delay:.4s}
@keyframes pulse{0%,80%,100%{opacity:.2;transform:scale(.8)}40%{opacity:1;transform:scale(1)}}

.model-popup{display:none;position:fixed;background:var(--bg2);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:6px;min-width:240px;box-shadow:0 12px 40px rgba(0,0,0,0.6);z-index:99999}
.model-popup.show{display:block}
.mp-item{padding:8px 12px;border-radius:8px;font-size:13px;color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:space-between;transition:all .1s}
.mp-item:hover{background:var(--bg3);color:var(--text)}
.mp-item.active{color:var(--accent)}
.mp-item .ck{display:none;color:var(--accent)}.mp-item.active .ck{display:inline}

.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:15}
.overlay.show{display:block}
@media(max-width:768px){
.sidebar{position:fixed;left:0;top:0;bottom:0;transform:translateX(-100%)}
.sidebar.open{transform:translateX(0)}
.menu-btn{display:flex}
.msg-inner{padding:0 16px}
.input-area{padding:8px 12px 12px}
}
</style>
</head>
<body>
<div class="app">
<div class="overlay" id="overlay" onclick="toggleSB()"></div>
<div class="sidebar" id="sidebar">
<div class="sb-top"><div class="sb-logo">ü¶û EasyClaw <span>chat</span></div><button class="sb-new" onclick="newChat()" title="Êñ∞„Åó„ÅÑ„ÉÅ„É£„ÉÉ„Éà">+</button></div>
<div class="sb-sessions" id="sessionList"></div>
<div class="sb-footer"><a href="/app.html#dashboard"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</a></div>
</div>
<div class="main">
<div class="topbar">
<div class="tb-left">
<button class="menu-btn" onclick="toggleSB()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="15" y2="12"/><line x1="3" y1="18" x2="18" y2="18"/></svg></button>
<span class="tb-title" id="topTitle">Êñ∞„Åó„ÅÑ„ÉÅ„É£„ÉÉ„Éà</span>
</div>
<div class="tb-right"><div class="tb-status"><span class="tb-dot" id="statusDot"></span><span id="statusText">Êé•Á∂ö‰∏≠</span></div></div>
</div>
<div class="content-area">
<div class="welcome" id="welcome">
<div class="w-icon">ü¶û</div>
<div class="w-title" id="greeting"></div>
<div class="w-sub">‰Ωï„Åß„ÇÇËÅû„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ</div>
</div>
<div class="messages" id="messages"></div>
</div>
<div class="input-area">
<div class="input-box" style="max-width:680px;margin:0 auto;position:relative">
<div class="file-preview" id="filePreview"></div>
<textarea id="chatInput" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ..." rows="1" onkeydown="hk(event)" oninput="ar(this)"></textarea>
<div class="input-toolbar">
<div class="input-toolbar-left">
<button class="tb-btn" onclick="triggerFile()" title="„Éï„Ç°„Ç§„É´Ê∑ª‰ªò"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg></button>
</div>
<div class="input-toolbar-right">
<button class="model-btn" id="modelBtn" onclick="toggleModel()"><span id="modelLabel">sonnet-4.5</span> <span style="font-size:10px">‚ñæ</span></button>
<button class="send-btn" id="sendBtn" onclick="send()"><svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>
</div>
</div>

</div>
</div>
</div>
</div>
<div class="model-popup" id="modelPopup">
<div style="padding:4px 12px 6px;font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.8px">Anthropic</div>
<div class="mp-item active" onclick="setModel('anthropic/claude-sonnet-4-5-20250929','sonnet-4.5',this)">Claude Sonnet 4.5<span class="ck">‚úì</span></div>
<div class="mp-item" onclick="setModel('anthropic/claude-haiku-4-5-20251001','haiku-4.5',this)">Claude Haiku 4.5<span class="ck">‚úì</span></div>
<div style="padding:8px 12px 6px;font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;border-top:1px solid rgba(255,255,255,0.04);margin-top:4px">OpenAI</div>
<div class="mp-item" onclick="setModel('openai/gpt-4o','gpt-4o',this)">GPT-4o<span class="ck">‚úì</span></div>
<div class="mp-item" onclick="setModel('openai/gpt-4o-mini','gpt-4o-mini',this)">GPT-4o Mini<span class="ck">‚úì</span></div>
<div style="padding:8px 12px 6px;font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;border-top:1px solid rgba(255,255,255,0.04);margin-top:4px">Google</div>
<div class="mp-item" onclick="setModel('google/gemini-2.0-flash','gemini-flash',this)">Gemini 2.0 Flash<span class="ck">‚úì</span></div>
<div class="mp-item" onclick="setModel('google/gemini-2.0-pro','gemini-pro',this)">Gemini 2.0 Pro<span class="ck">‚úì</span></div>
</div>
<input type="file" id="fileInput" style="display:none" multiple accept="image/*,.pdf,.txt,.csv,.json,.md" onchange="handleFiles(this)">
<script>
var T=localStorage.getItem("token");if(!T)location.href="/app.html";
var sessionLabels={};
async function fetchSessionLabels(){
if(busy)return;
var todo=sessions.filter(function(s){return !sessionLabels[s.key]&&s.key.indexOf("web")>-1}).slice(0,3);
for(var i=0;i<todo.length;i++){
(function(s){setTimeout(function(){
if(busy)return;
api("/api/chat/history?sessionKey="+encodeURIComponent(s.key)).then(function(d){
var msgs=d.messages||[];sessionLabels[s.key]=genTitle(msgs);renderSB()
}).catch(function(){sessionLabels[s.key]="„ÉÅ„É£„ÉÉ„Éà"})
},i*2000)})(todo[i])}}
var curSession=null,sessions=[],busy=false,attachedFiles=[],msgCount=0,currentModel="anthropic/claude-sonnet-4-5-20250929";
function api(u,o){o=o||{};o.headers=Object.assign({"Authorization":"Bearer "+T,"Content-Type":"application/json"},o.headers||{});return fetch(u,o).then(function(r){return r.json()})}
async function init(){setGreeting();await checkHealth();await loadSessions();document.getElementById("chatInput").focus()}
function setGreeting(){var h=new Date().getHours();document.getElementById("greeting").textContent=h<5?"„Åì„Çì„Å∞„Çì„ÅØ":h<12?"„Åä„ÅØ„Çà„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô":h<18?"„Åì„Çì„Å´„Å°„ÅØ":"„Åì„Çì„Å∞„Çì„ÅØ"}
async function checkHealth(){try{var h=await api("/api/chat/health");if(h.ok){document.getElementById("statusDot").className="tb-dot";document.getElementById("statusText").textContent="„Ç™„É≥„É©„Ç§„É≥"}else throw 0}catch(e){document.getElementById("statusDot").className="tb-dot off";document.getElementById("statusText").textContent="„Ç™„Éï„É©„Ç§„É≥"}}
async function loadSessions(){try{var d=await api("/api/chat/sessions");sessions=(d.sessions||[]).filter(function(s){return s.key.indexOf("web")>-1});sessions.sort(function(a,b){return(b.updatedAt||0)-(a.updatedAt||0)});renderSB();fetchSessionLabels()}catch(e){}}
function renderSB(){var el=document.getElementById("sessionList");if(!sessions.length){el.innerHTML='<div style="padding:24px 12px;text-align:center;color:var(--text3);font-size:12px">„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„Å™„Åó</div>';return}var now=Date.now(),html="",prev="";sessions.forEach(function(s){var diff=now-(s.updatedAt||0);var lb=diff<86400000?"‰ªäÊó•":diff<172800000?"Êò®Êó•":diff<604800000?"‰ªäÈÄ±":"„Åù„Çå‰ª•Ââç";if(lb!==prev){html+='<div class="sb-label">'+lb+'</div>';prev=lb}var nm=sessionLabels[s.key]||s.label||"„ÉÅ„É£„ÉÉ„Éà";var ac=s.key===curSession?" active":"";html+='<div class="sb-item'+ac+'" onclick="openSession(\''+s.key+'\')" ondblclick="renameSession(event,\''+s.key+'\')">'+esc(nm)+'</div>'});el.innerHTML=html}
function openSession(k){curSession=k;msgCount=0;renderSB();showChat();loadHistory(k);closeSB()}
async function loadHistory(k){var m=document.getElementById("messages");m.innerHTML='<div style="padding:40px;text-align:center;color:var(--text3)">Ë™≠„ÅøËæº„Åø‰∏≠...</div>';try{var d=await api("/api/chat/history?sessionKey="+encodeURIComponent(k));var msgs=d.messages||[];if(msgs.length>0){var t=genTitle(msgs);document.getElementById("topTitle").textContent=t;sessionLabels[k]=t;renderSB()};m.innerHTML=msgs.map(renderMsg).join("");m.scrollTop=m.scrollHeight;msgCount=msgs.length}catch(e){m.innerHTML='<div style="padding:40px;text-align:center;color:#ef4444">Ë™≠„ÅøËæº„ÅøÂ§±Êïó</div>'}}
function genTitle(msgs){for(var i=0;i<msgs.length;i++){if(msgs[i].role==="user"){var c=msgs[i].content;var txt=typeof c==="string"?c:(c[0]&&c[0].text?c[0].text:"");if(txt.length>0)return txt.slice(0,30)+(txt.length>30?"...":"")}}return"„ÉÅ„É£„ÉÉ„Éà"}
function renderMsg(msg){if(msg.role==="system")return"";var ft="";if(typeof msg.content==="string")ft=msg.content;if(Array.isArray(msg.content)){var fb=msg.content.find(function(x){return x.type==="text"&&x.text});if(fb)ft=fb.text||""}if(ft.trim().startsWith("System:")||/^\[(?:Mon|Tue|Wed|Thu|Fri|Sat|Sun) /.test(ft.trim()))return"";var isU=msg.role==="user";var cls=isU?"user":"assistant";var icon=isU?'<div class="msg-icon u">You</div>':'<div class="msg-icon a">ü¶û</div>';var body="";var c=msg.content||[];if(typeof c==="string")c=[{type:"text",text:c}];c.forEach(function(x){if(x.type==="thinking"||x.type==="tool_use"||x.type==="tool_result")return;if(x.type==="text"&&x.text){var t=x.text.trim();if(!t)return;if(t.charAt(0)==="{"&&t.indexOf("status")>-1)return;if(t.indexOf("ENOENT")>-1)return;if(t.indexOf("## „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±")>-1)return;body+='<div>'+fmt(t)+'</div>'}});if(!body)return"";var t=msg.timestamp?new Date(msg.timestamp).toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit"}):"";return'<div class="msg-wrap '+cls+'"><div class="msg-inner">'+icon+'<div class="msg-content">'+body+(t?'<div class="msg-time">'+t+'</div>':'')+'</div></div></div>'}
async function send(){var inp=document.getElementById("chatInput");var txt=inp.value.trim();if(!txt||busy)return;busy=true;document.getElementById("sendBtn").disabled=true;inp.value="";ar(inp);if(!curSession){curSession="agent:main:web-"+Date.now();clearMessages();showChat()}if(!sessionLabels[curSession]){var tt=txt.slice(0,30)+(txt.length>30?"...":"");document.getElementById("topTitle").textContent=tt;sessionLabels[curSession]=tt;renderSB()}var m=document.getElementById("messages");m.innerHTML+=renderMsg({role:"user",content:[{type:"text",text:txt}],timestamp:Date.now()});msgCount++;m.innerHTML+='<div class="msg-wrap assistant" id="typing"><div class="msg-inner"><div class="msg-icon a">ü¶û</div><div class="msg-content"><div class="typing-dots"><span></span><span></span><span></span></div></div></div></div>';m.scrollTop=m.scrollHeight;attachedFiles=[];document.getElementById("filePreview").innerHTML="";try{await api("/api/chat/send",{method:"POST",body:JSON.stringify({sessionKey:curSession,message:txt,model:currentModel})});var att=0;await new Promise(r=>setTimeout(r,2000));var iv=setInterval(async function(){att++;try{var h=await api("/api/chat/history?sessionKey="+encodeURIComponent(curSession));var ms=h.messages||[];var last=ms[ms.length-1];if(last&&last.role==="assistant"&&ms.length>msgCount){clearInterval(iv);msgCount=ms.length;
var err=last.errorMessage||"";
if(err){
var errDiv='<div class="msg-wrap assistant"><div class="msg-inner"><div class="msg-icon a">‚ö†Ô∏è</div><div class="msg-content"><div style="color:#ef4444;font-weight:500">„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</div>';
if(err.indexOf("credit balance is too low")>-1){
errDiv+='<div style="margin-top:8px">API„ÇØ„É¨„Ç∏„ÉÉ„ÉàÊÆãÈ´ò„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ<br><a href="https://console.anthropic.com/settings/plans" target="_blank" style="color:var(--accent);text-decoration:underline">Anthropic Console</a>„Åß„ÇØ„É¨„Ç∏„ÉÉ„Éà„Çí„ÉÅ„É£„Éº„Ç∏„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</div>';
}else if(err.indexOf("rate_limit")>-1){
errDiv+='<div style="margin-top:8px">API„ÅÆ„É¨„Éº„ÉàÂà∂Èôê„Å´ÈÅî„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ</div>';
}else if(err.indexOf("invalid_api_key")>-1||err.indexOf("authentication")>-1){
errDiv+='<div style="margin-top:8px">API„Ç≠„Éº„ÅåÁÑ°Âäπ„Åß„Åô„ÄÇ<a href="/app.html#dashboard" style="color:var(--accent);text-decoration:underline">„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</a>„ÅßË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</div>';
}else{
errDiv+='<div style="margin-top:8px;font-size:12px;color:var(--text3)">'+esc(err.substring(0,200))+'</div>';
}
errDiv+='</div></div></div>';
m.innerHTML=ms.filter(function(x){return x.role!=="assistant"||!x.errorMessage}).map(renderMsg).join("")+errDiv;
}else{
m.innerHTML=ms.map(renderMsg).join("");
}
m.scrollTop=m.scrollHeight;busy=false;document.getElementById("sendBtn").disabled=false;sessionLabels[curSession]=document.getElementById("topTitle").textContent;renderSB()}}catch(e){}if(att>=60){clearInterval(iv);var t=document.getElementById("typing");if(t)t.remove();busy=false;document.getElementById("sendBtn").disabled=false};var tt=document.getElementById("typing");if(!busy&&tt)tt.remove()},1000)}catch(e){var t=document.getElementById("typing");if(t)t.remove();busy=false;document.getElementById("sendBtn").disabled=false}}
function showChat(){document.getElementById("welcome").classList.add("hidden");var m=document.getElementById("messages");m.classList.add("show");document.getElementById("chatInput").focus()}
function clearMessages(){document.getElementById("messages").innerHTML=""}
function showWelcome(){document.getElementById("welcome").classList.remove("hidden");document.getElementById("messages").classList.remove("show");document.getElementById("messages").innerHTML="";document.getElementById("topTitle").textContent="Êñ∞„Åó„ÅÑ„ÉÅ„É£„ÉÉ„Éà"}
function renameSession(e,key){e.stopPropagation();var el=e.target;var cur=sessionLabels[key]||el.textContent;var input=document.createElement("input");input.type="text";input.value=cur;input.style.cssText="width:100%;background:var(--bg4);border:1px solid var(--accent);border-radius:4px;color:var(--text);font-size:13px;padding:4px 6px;font-family:inherit;outline:none";el.innerHTML="";el.appendChild(input);input.focus();input.select();function save(){var v=input.value.trim();if(v){sessionLabels[key]=v}el.textContent=sessionLabels[key]||"„ÉÅ„É£„ÉÉ„Éà";if(key===curSession)document.getElementById("topTitle").textContent=sessionLabels[key]}input.addEventListener("blur",save);input.addEventListener("keydown",function(ev){if(ev.key==="Enter"){ev.preventDefault();save()}if(ev.key==="Escape"){el.textContent=cur}})}
function newChat(){curSession=null;msgCount=0;renderSB();showWelcome();closeSB();document.getElementById("chatInput").focus()}
function hk(e){if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();send()}}
function ar(el){el.style.height="auto";el.style.height=Math.min(el.scrollHeight,200)+"px"}
function toggleSB(){document.getElementById("sidebar").classList.toggle("open");document.getElementById("overlay").classList.toggle("show")}
function closeSB(){document.getElementById("sidebar").classList.remove("open");document.getElementById("overlay").classList.remove("show")}
function esc(s){var d=document.createElement("div");d.textContent=s;return d.innerHTML}
function fmt(t){var h=esc(t);h=h.replace(/```(\w*)\n([\s\S]*?)```/g,'<pre><code>$2</code></pre>');h=h.replace(/`([^`]+)`/g,'<code>$1</code>');h=h.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>');h=h.replace(/\n/g,'<br>');return h}
function triggerFile(){document.getElementById("fileInput").click()}
function handleFiles(input){for(var i=0;i<input.files.length;i++)attachedFiles.push(input.files[i]);renderFP();input.value=""}
function renderFP(){document.getElementById("filePreview").innerHTML=attachedFiles.map(function(f,i){return'<div class="file-tag">üìé '+esc(f.name)+' <span class="rm" onclick="rmFile('+i+')">√ó</span></div>'}).join("")}
function rmFile(i){attachedFiles.splice(i,1);renderFP()}
function toggleModel(){var mp=document.getElementById("modelPopup");var btn=document.getElementById("modelBtn");var r=btn.getBoundingClientRect();mp.style.bottom=(window.innerHeight-r.top+8)+"px";mp.style.right=(window.innerWidth-r.right)+"px";mp.classList.toggle("show")}
function setModel(id,label,el){currentModel=id;document.getElementById("modelLabel").textContent=label;document.querySelectorAll(".mp-item").forEach(function(e){e.classList.remove("active")});el.classList.add("active");document.getElementById("modelPopup").classList.remove("show")}
document.addEventListener("click",function(e){var mp=document.getElementById("modelPopup"),mb=document.getElementById("modelBtn");if(!mp.contains(e.target)&&!mb.contains(e.target))mp.classList.remove("show")});
init();
</script>
</body>
</html>
