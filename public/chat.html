<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>EasyClaw Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700&family=JetBrains+Mono:wght@300;400;500&family=Noto+Sans+JP:wght@200;300;400;500;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
--black:#050505;--dark:#0a0a0a;--dark2:#111;--dark3:#1a1a1a;--dark4:#222;
--text:#e8e8e8;--text2:#888;--text3:#555;
--green:#00ff41;--green2:#00cc33;--greenDim:rgba(0,255,65,0.08);--greenGlow:rgba(0,255,65,0.15);
--accent:#e8562a;--accent2:#ff7040;
}
html,body{height:100%;font-family:'Inter','Noto Sans JP',-apple-system,sans-serif;background:var(--black);color:var(--text);overflow:hidden;-webkit-font-smoothing:antialiased}
::selection{background:var(--greenGlow);color:var(--green)}
.app{display:flex;height:100vh;height:100dvh}

/* Sidebar */
.sidebar{width:260px;min-width:260px;background:var(--dark);display:flex;flex-direction:column;border-right:1px solid rgba(255,255,255,0.04);z-index:20;transition:transform .25s;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
.sb-top{padding:12px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,0.04)}
.sb-logo{font-size:14px;font-weight:600;display:flex;align-items:center;gap:6px;text-decoration:none;color:var(--text)}
.sb-logo span{color:var(--green);font-size:11px;font-weight:400;font-family:'JetBrains Mono',monospace}
.sb-new{width:32px;height:32px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all .15s}
.sb-new:hover{background:rgba(0,255,65,0.05);color:var(--green);border-color:rgba(0,255,65,0.2)}
.sb-sessions{flex:1;overflow-y:auto;padding:4px 8px}
.sb-sessions::-webkit-scrollbar{width:3px}
.sb-sessions::-webkit-scrollbar-thumb{background:var(--dark4);border-radius:3px}
.sb-label{font-size:9px;font-weight:500;color:var(--text3);padding:12px 8px 4px;text-transform:uppercase;letter-spacing:1.2px;font-family:'JetBrains Mono',monospace}
.sb-item{padding:8px 10px;border-radius:8px;cursor:pointer;margin-bottom:1px;font-size:13px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;transition:all .15s}
.sb-item:hover{background:rgba(255,255,255,0.03);color:var(--text)}
.sb-item.active{background:rgba(0,255,65,0.05);color:var(--green);border-left:2px solid var(--green);padding-left:8px}
.sb-footer{padding:10px 12px;border-top:1px solid rgba(255,255,255,0.04);display:flex;flex-direction:column;gap:2px}
.sb-footer a{display:flex;align-items:center;gap:6px;color:var(--text3);font-size:12px;text-decoration:none;padding:6px 8px;border-radius:6px;transition:all .15s}
.sb-footer a:hover{color:var(--green);background:rgba(0,255,65,0.03)}

/* Main */
.main{flex:1;display:flex;flex-direction:column;min-width:0;position:relative}
.topbar{height:48px;display:flex;align-items:center;justify-content:space-between;padding:0 20px;border-bottom:1px solid rgba(255,255,255,0.04);flex-shrink:0;backdrop-filter:blur(10px);background:rgba(5,5,5,0.8)}
.tb-left{display:flex;align-items:center;gap:8px}
.menu-btn{display:none;background:none;border:none;color:var(--text2);cursor:pointer;padding:4px}
.menu-btn svg{width:18px;height:18px}
.tb-title{font-size:13px;font-weight:500;color:var(--text)}
.tb-right{display:flex;align-items:center;gap:8px}
.tb-status{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--text3);font-family:'JetBrains Mono',monospace}
.tb-dot{width:6px;height:6px;border-radius:50%;background:var(--green);box-shadow:0 0 8px rgba(0,255,65,0.4)}
.tb-dot.off{background:#ef4444;box-shadow:0 0 8px rgba(239,68,68,0.4)}

/* Workspace bar */
.ws-bar{display:none;height:32px;align-items:center;gap:8px;padding:0 20px;border-bottom:1px solid rgba(255,255,255,0.04);flex-shrink:0;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text3);background:rgba(5,5,5,0.6);overflow:hidden}
.ws-bar.show{display:flex}
.ws-bar .ws-branch{display:inline-flex;align-items:center;gap:4px;color:var(--green);background:rgba(0,255,65,0.05);border:1px solid rgba(0,255,65,0.12);padding:2px 8px;border-radius:4px;font-size:10px;white-space:nowrap}
.ws-bar .ws-path{color:var(--text3);opacity:.6;font-size:10px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ws-bar .ws-stat{display:inline-flex;align-items:center;gap:3px;padding:2px 6px;border-radius:4px;font-size:10px;white-space:nowrap}
.ws-bar .ws-stat.changes{color:var(--accent);background:rgba(232,86,42,0.08);border:1px solid rgba(232,86,42,0.15)}
.ws-bar .ws-stat.clean{color:var(--text3);opacity:.5}
.ws-bar .ws-files{color:var(--text3);opacity:.5;font-size:10px;margin-left:auto;white-space:nowrap}
.ws-bar .ws-btn{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:4px;font-size:10px;color:var(--text2);background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);cursor:pointer;white-space:nowrap;transition:all .15s}
.ws-bar .ws-btn:hover{background:rgba(0,255,65,0.05);color:var(--green);border-color:rgba(0,255,65,0.2)}

/* Content */
.content-area{flex:1;display:flex;flex-direction:column;min-height:0}
.welcome{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 24px}
.welcome.hidden{display:none}
.w-icon{font-size:40px;margin-bottom:16px;opacity:.6}
.w-title{font-family:'Playfair Display',serif;font-size:24px;font-weight:500;margin-bottom:8px;letter-spacing:-.3px}
.w-sub{font-size:14px;color:var(--text3);font-weight:300}

/* Messages */
.messages{flex:1;overflow-y:auto;padding:20px 0;display:none}
.messages.show{display:block}
.messages::-webkit-scrollbar{width:4px}
.messages::-webkit-scrollbar-thumb{background:var(--dark4);border-radius:4px}
.msg-wrap{padding:10px 0}
.msg-wrap.assistant{background:transparent}
.msg-inner{max-width:700px;margin:0 auto;padding:0 24px;display:flex;gap:10px;align-items:flex-end}
.msg-wrap.user .msg-inner{flex-direction:row-reverse}
.msg-icon{width:26px;height:26px;border-radius:8px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:12px}
.msg-icon.u{background:var(--accent);color:#fff;font-weight:600;font-size:9px;letter-spacing:.5px}
.msg-icon.a{background:rgba(0,255,65,0.08);color:var(--green);font-size:14px;border:1px solid rgba(0,255,65,0.1)}
.msg-content{max-width:80%;min-width:0;font-size:14px;line-height:1.8;font-weight:400;color:var(--text)}
.msg-wrap.user .msg-content{background:rgba(232,86,42,0.12);border:1px solid rgba(232,86,42,0.18);padding:10px 16px;border-radius:18px 18px 4px 18px;text-align:left}
.msg-wrap.assistant .msg-content{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.05);padding:10px 16px;border-radius:18px 18px 18px 4px}
.msg-content p{margin-bottom:8px}.msg-content p:last-child{margin-bottom:0}
.msg-content strong{font-weight:600;color:var(--text)}
.msg-content code{font-family:'JetBrains Mono',monospace;font-size:12px;background:rgba(0,255,65,0.05);border:1px solid rgba(0,255,65,0.08);padding:1px 6px;border-radius:4px;color:var(--green)}
.msg-content pre{background:var(--dark);border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:16px;margin:12px 0;overflow-x:auto;font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.7}
.msg-content pre code{background:none;border:none;padding:0;color:var(--text)}
.msg-content h2.md-h,.msg-content h3.md-h,.msg-content h4.md-h{margin:14px 0 6px;color:var(--text);font-weight:600;line-height:1.4}
.msg-content h2.md-h{font-size:16px}.msg-content h3.md-h{font-size:14px}.msg-content h4.md-h{font-size:13px}
.msg-content ul.md-list,.msg-content ol.md-list{margin:6px 0;padding-left:20px;line-height:1.8;font-size:13px}
.msg-content .md-list li{margin:2px 0}.msg-content .md-list li::marker{color:var(--text3)}
.msg-content em{font-style:italic;color:var(--text2)}
.msg-content a.md-link{color:var(--green);text-decoration:none;border-bottom:1px solid rgba(0,255,65,0.2)}.msg-content a.md-link:hover{border-bottom-color:var(--green)}
.msg-time{font-size:10px;color:var(--text3);margin-top:6px;font-family:'JetBrains Mono',monospace}
.msg-wrap.user .msg-time{text-align:right}

/* Input */
.input-area{padding:12px 24px 20px;flex-shrink:0}
.input-box{max-width:700px;margin:0 auto;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:16px;overflow:hidden;transition:all .2s;backdrop-filter:blur(10px)}
.input-box:focus-within{border-color:rgba(0,255,65,0.2);box-shadow:0 0 0 3px rgba(0,255,65,0.03)}
.input-box textarea{width:100%;min-height:44px;max-height:200px;background:transparent;border:none;padding:14px 18px 8px;color:var(--text);font-size:14px;font-family:inherit;resize:none;outline:none;line-height:1.5}
.input-box textarea::placeholder{color:var(--text3)}
.input-toolbar{display:flex;align-items:center;justify-content:space-between;padding:4px 8px 8px}
.input-toolbar-left{display:flex;align-items:center;gap:2px}
.input-toolbar-right{display:flex;align-items:center;gap:6px}
.tb-btn{width:32px;height:32px;border-radius:8px;border:none;background:transparent;color:var(--text3);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.tb-btn:hover{background:rgba(255,255,255,0.04);color:var(--text2)}
.tb-btn svg{width:18px;height:18px}
.model-btn{display:flex;align-items:center;gap:4px;padding:4px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text3);cursor:pointer;font-size:11px;font-family:'JetBrains Mono',monospace;transition:all .15s}
.model-btn:hover{background:rgba(0,255,65,0.03);border-color:rgba(0,255,65,0.15);color:var(--green)}
.send-btn{width:34px;height:34px;border-radius:10px;border:none;background:var(--accent);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.send-btn:hover{background:var(--accent2);transform:translateY(-1px);box-shadow:0 4px 15px rgba(232,86,42,0.3)}
.send-btn:disabled{opacity:.3;cursor:not-allowed;transform:none;box-shadow:none}
.send-btn svg{width:16px;height:16px}

.file-preview{display:flex;gap:6px;padding:4px 12px;flex-wrap:wrap}
.file-tag{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:8px;font-size:11px;color:var(--text2)}
.file-tag .rm{cursor:pointer;opacity:.5;font-size:13px}.file-tag .rm:hover{opacity:1;color:#ef4444}

.typing-dots{display:inline-flex;gap:3px;padding:2px 0}
.typing-dots span{width:5px;height:5px;border-radius:50%;background:var(--green);animation:pulse 1.4s infinite both}
.typing-dots span:nth-child(2){animation-delay:.2s}
.typing-dots span:nth-child(3){animation-delay:.4s}
@keyframes pulse{0%,80%,100%{opacity:.2;transform:scale(.8)}40%{opacity:1;transform:scale(1)}}

/* Model Popup */
.model-popup{display:none;position:fixed;background:var(--dark);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:6px;min-width:240px;box-shadow:0 16px 48px rgba(0,0,0,0.6);z-index:99999;backdrop-filter:blur(20px)}
.model-popup.show{display:block}
.mp-section{padding:6px 12px 4px;font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:1.2px;font-family:'JetBrains Mono',monospace}
.mp-section:not(:first-child){border-top:1px solid rgba(255,255,255,0.04);margin-top:4px;padding-top:10px}
.mp-item{padding:8px 12px;border-radius:8px;font-size:13px;color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:space-between;transition:all .1s}
.mp-item:hover{background:rgba(0,255,65,0.03);color:var(--text)}
.mp-item.active{color:var(--green)}
.mp-item .ck{display:none;color:var(--green);font-size:12px}.mp-item.active .ck{display:inline}

.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:15}
.overlay.show{display:block}

/* Quick tips on welcome */
.quick-tips{display:flex;flex-wrap:wrap;gap:10px;margin-top:24px;max-width:520px;justify-content:center}
.tip-card{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:14px 18px;cursor:pointer;transition:all .2s;flex:1;min-width:140px;max-width:240px;text-align:left}
.tip-card:hover{border-color:rgba(0,255,65,0.2);background:rgba(0,255,65,0.02);transform:translateY(-2px)}
.tip-title{font-size:12px;font-weight:600;color:var(--text);margin-bottom:4px;display:flex;align-items:center;gap:6px}
.tip-desc{font-size:11px;color:var(--text3);line-height:1.5}

/* Help popup */
.help-btn-chat{display:inline-flex;align-items:center;gap:6px;font-size:11px;color:var(--text3);cursor:pointer;font-family:'JetBrains Mono',monospace;transition:color .2s;padding:4px 0}
.help-btn-chat:hover{color:var(--green)}
.help-btn-chat .qm{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;background:rgba(0,255,65,0.08);border:1px solid rgba(0,255,65,0.15);color:var(--green);font-size:9px;font-weight:700}

.help-popup-chat{display:none;position:fixed;z-index:200;width:360px;max-width:90vw;background:var(--dark);border:1px solid rgba(0,255,65,0.15);border-radius:16px;padding:24px;box-shadow:0 16px 48px rgba(0,0,0,0.6);backdrop-filter:blur(20px);top:50%;left:50%;transform:translate(-50%,-50%)}
.help-popup-chat.show{display:block}
.help-popup-chat h3{font-size:15px;font-weight:600;color:var(--text);margin-bottom:14px}
.help-popup-chat .close-help{position:absolute;top:12px;right:14px;background:none;border:none;color:var(--text3);cursor:pointer;font-size:18px}
.help-popup-chat .close-help:hover{color:var(--text)}
.help-popup-chat .help-item{padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.04);font-size:13px;color:var(--text2);line-height:1.7}
.help-popup-chat .help-item:last-child{border-bottom:none}
.help-popup-chat .help-item strong{color:var(--text);font-weight:500}
.help-popup-chat .help-item code{font-family:'JetBrains Mono',monospace;font-size:11px;background:rgba(0,255,65,0.05);border:1px solid rgba(0,255,65,0.08);padding:1px 5px;border-radius:4px;color:var(--green)}
.help-popup-chat a.help-ext{display:inline-flex;align-items:center;gap:4px;color:var(--green);text-decoration:none;font-size:12px;margin-top:10px;font-family:'JetBrains Mono',monospace}
.help-popup-chat a.help-ext:hover{text-decoration:underline}
.chat-help-overlay{display:none;position:fixed;inset:0;z-index:199;background:rgba(0,0,0,0.4)}
.chat-help-overlay.show{display:block}

/* Agent Progress ‚Äî Claude Code style */
.agent-progress{margin:8px 0 10px;border-left:2px solid rgba(0,255,65,0.12);padding-left:12px}
.ap-step{display:flex;align-items:center;gap:6px;padding:2px 0;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text3);line-height:1.5}
.ap-step.active{color:var(--green)}
.ap-step .ap-mark{width:14px;flex-shrink:0;text-align:center;font-size:9px}
.ap-spin{display:inline-block;width:8px;height:8px;border:1.5px solid rgba(0,255,65,0.2);border-top-color:var(--green);border-radius:50%;animation:spin .6s linear infinite}
.ap-detail{opacity:.5;margin-left:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:220px}
.agent-progress.all-done{opacity:.5}
@keyframes spin{to{transform:rotate(360deg)}}

/* Orchestrator label */
.orch-label{font-size:10px;color:var(--text3);font-family:'JetBrains Mono',monospace;padding:4px 0 6px;display:flex;align-items:center;gap:4px;border-bottom:1px solid rgba(255,255,255,0.04);margin-bottom:6px}
.orch-reason{color:var(--text3);opacity:.6;font-size:9px}

/* Gateway status in topbar */
.tb-gw{font-size:10px;color:var(--text3);font-family:'JetBrains Mono',monospace;margin-left:12px;padding:3px 8px;border-radius:4px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.05)}
.tb-gw.on{color:var(--green);border-color:rgba(0,255,65,0.15);background:rgba(0,255,65,0.03)}

@media(max-width:768px){
.sidebar{position:fixed;left:0;top:0;bottom:0;transform:translateX(-100%)}
.sidebar.open{transform:translateX(0)}
.menu-btn{display:flex}
.msg-inner{padding:0 16px}
.input-area{padding:8px 12px 12px}
}
</style>
</head>
<body>
<div class="app">
<div class="overlay" id="overlay" onclick="toggleSB()"></div>
<div class="sidebar" id="sidebar">
<div class="sb-top"><a href="/" class="sb-logo">ü¶û EasyClaw <span>chat</span></a><button class="sb-new" onclick="newChat()" title="Êñ∞„Åó„ÅÑ„ÉÅ„É£„ÉÉ„Éà">+</button></div>
<div class="sb-sessions" id="sessionList"></div>
<div class="sb-footer">
<a href="/setup.html"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>Ë®≠ÂÆö</a>
<a onclick="showChatHelp()" style="cursor:pointer"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>„Éò„É´„Éó</a>
<a onclick="doLogout()" style="cursor:pointer"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"/></svg>„É≠„Ç∞„Ç¢„Ç¶„Éà</a>
</div>
</div>
<div class="main">
<div class="topbar">
<div class="tb-left">
<button class="menu-btn" onclick="toggleSB()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="15" y2="12"/><line x1="3" y1="18" x2="18" y2="18"/></svg></button>
<span class="tb-title" id="topTitle">Êñ∞„Åó„ÅÑ„ÉÅ„É£„ÉÉ„Éà</span>
</div>
<div class="tb-right"><div class="tb-status"><span class="tb-dot" id="statusDot"></span><span id="statusText">Êé•Á∂ö‰∏≠</span></div><span class="tb-gw" id="gwBadge">GW: ---</span></div>
</div>
<div class="ws-bar" id="wsBar"></div>
<div class="content-area">
<div class="welcome" id="welcome">
<div class="w-icon">ü¶û</div>
<div class="w-title" id="greeting"></div>
<div class="w-sub">‰Ωï„Åß„ÇÇËÅû„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ</div>
<div class="quick-tips">
  <div class="tip-card" onclick="insertPrompt('„ÉØ„Éº„ÇØ„Çπ„Éö„Éº„Çπ„Å´git init„Åó„Å¶„ÄÅREADME.md„Çí‰ΩúÊàê„Åó„Å¶')">
    <div class="tip-title">üêô GitHub</div>
    <div class="tip-desc">GitÂàùÊúüÂåñ„Éª„É™„Éù„Ç∏„Éà„É™ÁÆ°ÁêÜ</div>
  </div>
  <div class="tip-card" onclick="insertPrompt('Python„ÅßÁ∞°Âçò„Å™Web„Çπ„ÇØ„É¨„Ç§„Éë„Éº„Çí‰Ωú„Å£„Å¶')">
    <div class="tip-title">üíª „Ç≥„Éº„ÉâÁîüÊàê</div>
    <div class="tip-desc">„Éó„É≠„Ç∞„É©„Éü„É≥„Ç∞„ÇíÊâã‰ºù„Å£„Å¶„ÇÇ„Çâ„ÅÜ</div>
  </div>
  <div class="tip-card" onclick="insertPrompt('https://example.com „ÇíÈñã„ÅÑ„Å¶ÂÜÖÂÆπ„ÇíÊïô„Åà„Å¶')">
    <div class="tip-title">üñ•Ô∏è „Éñ„É©„Ç¶„Ç∂</div>
    <div class="tip-desc">AI„Åå„Ç¶„Çß„Éñ„ÇíÈñ≤Ë¶ß„Åó„Å¶ÊÉÖÂ†±„ÇíÂèñÂæó</div>
  </div>
  <div class="tip-card" id="gitTipCard" style="display:none" onclick="insertPrompt('Â§âÊõ¥„Çí„Ç≥„Éü„ÉÉ„Éà„Åó„Å¶„ÄÅ„Éó„ÉÉ„Ç∑„É•„Åó„Å¶')">
    <div class="tip-title">üîÄ GitÊìç‰Ωú</div>
    <div class="tip-desc">„Ç≥„Éü„ÉÉ„Éà„Éª„Éó„ÉÉ„Ç∑„É•„ÉªPR‰ΩúÊàê</div>
  </div>
</div>
</div>
<div class="messages" id="messages"></div>
</div>
<div class="input-area">
<div class="input-box">
<div class="file-preview" id="filePreview"></div>
<textarea id="chatInput" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ..." rows="1" onkeydown="hk(event)" oninput="ar(this)"></textarea>
<div class="input-toolbar">
<div class="input-toolbar-left">
<button class="tb-btn" onclick="triggerFile()" title="„Éï„Ç°„Ç§„É´Ê∑ª‰ªò"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg></button>
</div>
<div class="input-toolbar-right">
<button class="model-btn" id="modelBtn" onclick="toggleModel()"><span id="modelLabel">...</span> <span style="font-size:10px">‚ñæ</span></button>
<button class="send-btn" id="sendBtn" onclick="send()"><svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="model-popup" id="modelPopup"></div>
<input type="file" id="fileInput" style="display:none" multiple accept="image/*,.pdf,.txt,.csv,.json,.md" onchange="handleFiles(this)">

<div class="chat-help-overlay" id="chatHelpOverlay" onclick="closeChatHelp()"></div>
<div class="help-popup-chat" id="chatHelpPopup">
  <button class="close-help" onclick="closeChatHelp()">&times;</button>
  <h3>üí° ‰Ωø„ÅÑÊñπ„Ç¨„Ç§„Éâ</h3>
  <div class="help-item"><strong>„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°</strong> ‚Äî ÂÖ•ÂäõÊ¨Ñ„Å´„ÉÜ„Ç≠„Çπ„Éà„ÇíÊâì„Å£„Å¶ Enter „Ç≠„Éº„ÅßÈÄÅ‰ø°„ÄÇShift+Enter „ÅßÊîπË°å„ÄÇ</div>
  <div class="help-item"><strong>„É¢„Éá„É´Âàá„ÇäÊõø„Åà</strong> ‚Äî ÂÖ•ÂäõÊ¨Ñ„ÅÆÂè≥‰∏ã„Å´„ÅÇ„Çã„É¢„Éá„É´Âêç„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®„ÄÅÂà•„ÅÆAI„É¢„Éá„É´„Å´Âàá„ÇäÊõø„Åà„Çâ„Çå„Åæ„Åô„ÄÇ</div>
  <div class="help-item"><strong>Êñ∞„Åó„ÅÑ„ÉÅ„É£„ÉÉ„Éà</strong> ‚Äî „Çµ„Ç§„Éâ„Éê„Éº„ÅÆ„Äå+„Äç„Éú„Çø„É≥„ÅßÊñ∞„Åó„ÅÑ‰ºöË©±„ÇíÈñãÂßã„Åß„Åç„Åæ„Åô„ÄÇ</div>
  <div class="help-item"><strong>„Ç®„Éº„Ç∏„Çß„É≥„ÉàÊ©üËÉΩ</strong> ‚Äî OpenClaw Gateway„ÅåËµ∑Âãï‰∏≠ÔºàÂè≥‰∏ä„ÅÆ„ÄåGW: ON„ÄçÔºâ„Å™„Çâ„ÄÅAI„ÅØ„ÉÑ„Éº„É´Âëº„Å≥Âá∫„Åó„ÇÑ„Çø„Çπ„ÇØÂÆüË°å„ÅåÂèØËÉΩ„Åß„Åô„ÄÇÂá¶ÁêÜ‰∏≠„ÅØ„ÉÅ„É£„ÉÉ„ÉàÂÜÖ„Å´„ÉÑ„Éº„É´„ÅÆÂÆüË°åÁä∂Ê≥Å„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ</div>
  <div class="help-item"><strong>AI„ÅåÂèçÂøú„Åó„Å™„ÅÑÂ†¥Âêà</strong> ‚Äî Âè≥‰∏ä„ÅÆ„ÄåOllama„Äç„Åå„Ç™„Éï„É©„Ç§„É≥„Å™„Çâ <code>ollama serve</code> „ÇíÂÆüË°å„ÄÇ„ÄåGW: OFF„Äç„Å™„Çâ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÁîªÈù¢„Åã„ÇâGateway„ÇíËµ∑Âãï„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</div>
  <div class="help-item"><strong>Ë®≠ÂÆöÂ§âÊõ¥</strong> ‚Äî „Çµ„Ç§„Éâ„Éê„Éº„ÅÆ„ÄåË®≠ÂÆö„Äç„Åã„Çâ„É¢„Éá„É´„ÇÑGateway„ÅÆË®≠ÂÆö„ÇíÂ§âÊõ¥„Åß„Åç„Åæ„Åô„ÄÇ</div>
  <a class="help-ext" href="https://ollama.com/library" target="_blank">‚Üó Âà©Áî®ÂèØËÉΩ„Å™„É¢„Éá„É´‰∏ÄË¶ß</a>
</div>
<script>
var T = localStorage.getItem("token");
if (!T) location.href = "/app.html";

var curSession = null, sessions = [], busy = false, attachedFiles = [], currentModel = "", userSettings = null, gatewayOnline = false, currentActivities = [];

function api(u, o) { o = o || {}; o.headers = Object.assign({ "Authorization": "Bearer " + T, "Content-Type": "application/json" }, o.headers || {}); return fetch(u, o).then(function(r) { return r.json() }) }

async function init() {
  setGreeting();
  await loadSettings();
  await checkHealth();
  await loadSessions();
  await loadWorkspaceStatus();
  document.getElementById("chatInput").focus();
}

async function loadWorkspaceStatus() {
  try {
    var ws = await api("/api/workspace/status");
    var bar = document.getElementById("wsBar");
    var html = "";
    if (ws.git) {
      html += '<span class="ws-branch">‚éá ' + esc(ws.git.branch || "main") + '</span>';
      if (ws.git.changed > 0) {
        html += '<span class="ws-stat changes">' + ws.git.changed + ' Â§âÊõ¥</span>';
      } else {
        html += '<span class="ws-stat clean">‚úì „ÇØ„É™„Éº„É≥</span>';
      }
      if (ws.git.ahead > 0) html += '<span class="ws-stat" style="color:var(--green)">‚Üë' + ws.git.ahead + '</span>';
      if (ws.git.behind > 0) html += '<span class="ws-stat" style="color:var(--accent)">‚Üì' + ws.git.behind + '</span>';
      if (ws.git.remote) {
        var repoName = ws.git.remote.replace(/.*[\/:]([^\/]+\/[^\/]+?)(?:\.git)?$/, "$1");
        html += '<span class="ws-btn" onclick="insertPrompt(\'„Åì„ÅÆ„É™„Éù„Ç∏„Éà„É™„ÅÆÁä∂ÊÖã„ÇíÊïô„Åà„Å¶\')" title="' + esc(ws.git.remote) + '">üêô ' + esc(repoName) + '</span>';
      }
      // Show git tip card
      var gitTip = document.getElementById("gitTipCard");
      if (gitTip) gitTip.style.display = "";
    } else {
      html += '<span class="ws-path">üìÅ ~/easyclaw-workspace</span>';
      html += '<span class="ws-stat clean">' + (ws.files || 0) + ' „Éï„Ç°„Ç§„É´</span>';
      html += '<span class="ws-btn" onclick="insertPrompt(\'„ÉØ„Éº„ÇØ„Çπ„Éö„Éº„Çπ„Å´git init„Åó„Å¶\')" title="GitÂàùÊúüÂåñ">‚äï git init</span>';
    }
    bar.innerHTML = html;
    bar.classList.add("show");
  } catch(e) { /* ignore */ }
}

function setGreeting() { var h = new Date().getHours(); document.getElementById("greeting").textContent = h < 5 ? "„Åì„Çì„Å∞„Çì„ÅØ" : h < 12 ? "„Åä„ÅØ„Çà„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô" : h < 18 ? "„Åì„Çì„Å´„Å°„ÅØ" : "„Åì„Çì„Å∞„Çì„ÅØ" }

async function loadSettings() {
  try {
    var d = await api("/api/settings");
    userSettings = d.settings;
    currentModel = "auto";
    document.getElementById("modelLabel").textContent = "ü§ñ auto";
    buildModelPopup();
  } catch(e) {
    currentModel = "auto";
    document.getElementById("modelLabel").textContent = "ü§ñ auto";
  }
}

async function buildModelPopup() {
  var popup = document.getElementById("modelPopup");
  var html = "";

  // Auto-orchestration option
  html += '<div class="mp-section">Orchestrator</div>';
  var autoActive = currentModel === "auto" ? " active" : "";
  html += '<div class="mp-item' + autoActive + '" onclick="setModel(\'auto\',this)">ü§ñ auto <span style="font-size:10px;color:var(--text3);margin-left:4px">„Çø„Çπ„ÇØ„Å´Âøú„Åò„Å¶Ëá™ÂãïÈÅ∏Êäû</span><span class="ck">‚úì</span></div>';

  if (!userSettings || userSettings.provider === "ollama") {
    html += '<div class="mp-section">Ollama (Local)</div>';
    try {
      var d = await api("/api/ollama/models");
      if (d.success && d.models.length > 0) {
        d.models.forEach(function(m) {
          var active = m.name === currentModel ? " active" : "";
          html += '<div class="mp-item' + active + '" onclick="setModel(\'' + m.name + '\',this)">' + m.name + '<span class="ck">‚úì</span></div>';
        });
      } else {
        html += '<div class="mp-item" style="color:var(--text3);cursor:default">„É¢„Éá„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</div>';
      }
    } catch(e) {
      html += '<div class="mp-item" style="color:var(--text3);cursor:default">OllamaÊú™Êé•Á∂ö</div>';
    }
  } else {
    var models = {
      google: [["google/gemini-2.5-flash","Gemini 2.5 Flash"],["google/gemini-2.5-pro","Gemini 2.5 Pro"]],
      anthropic: [["anthropic/claude-sonnet-4-5-20250929","Claude Sonnet 4.5"],["anthropic/claude-haiku-4-5-20251001","Claude Haiku 4.5"]],
      openai: [["openai/gpt-4o","GPT-4o"],["openai/gpt-4o-mini","GPT-4o Mini"]]
    };
    var provider = userSettings.provider;
    var names = { google: "Google", anthropic: "Anthropic", openai: "OpenAI" };
    html += '<div class="mp-section">' + (names[provider] || provider) + '</div>';
    (models[provider] || []).forEach(function(m) {
      var active = m[0] === currentModel ? " active" : "";
      html += '<div class="mp-item' + active + '" onclick="setModel(\'' + m[0] + '\',this)">' + m[1] + '<span class="ck">‚úì</span></div>';
    });
  }
  popup.innerHTML = html;
}

async function checkHealth() {
  // Check Ollama
  try {
    if (!userSettings || userSettings.provider === "ollama") {
      var h = await api("/api/ollama/health");
      if (h.ok) { document.getElementById("statusDot").className = "tb-dot"; document.getElementById("statusText").textContent = "OllamaÊé•Á∂ö‰∏≠"; }
      else throw 0;
    } else {
      document.getElementById("statusDot").className = "tb-dot";
      document.getElementById("statusText").textContent = "APIÊé•Á∂ö‰∏≠";
    }
  } catch(e) { document.getElementById("statusDot").className = "tb-dot off"; document.getElementById("statusText").textContent = "„Ç™„Éï„É©„Ç§„É≥"; }

  // Check Gateway
  try {
    var gw = await fetch("/api/openclaw/status").then(function(r){ return r.json() });
    gatewayOnline = gw.running && gw.connected;
    var badge = document.getElementById("gwBadge");
    if (gatewayOnline) { badge.textContent = "GW: ON"; badge.className = "tb-gw on"; }
    else if (gw.running) { badge.textContent = "GW: Ëµ∑Âãï‰∏≠"; badge.className = "tb-gw"; }
    else { badge.textContent = "GW: OFF"; badge.className = "tb-gw"; }
  } catch(e) {
    document.getElementById("gwBadge").textContent = "GW: ---";
    document.getElementById("gwBadge").className = "tb-gw";
  }
}

async function loadSessions() {
  try {
    var d = await api("/api/local/chat/sessions");
    sessions = d.sessions || [];
    renderSB();
  } catch(e) {}
}

function renderSB() {
  var el = document.getElementById("sessionList");
  if (!sessions.length) { el.innerHTML = '<div style="padding:24px 12px;text-align:center;color:var(--text3);font-size:12px;font-family:JetBrains Mono,monospace">No chats yet</div>'; return }
  var now = Date.now(), html = "", prev = "";
  sessions.forEach(function(s) {
    var ts = new Date(s.updatedAt || s.createdAt).getTime();
    var diff = now - ts;
    var lb = diff < 86400000 ? "‰ªäÊó•" : diff < 172800000 ? "Êò®Êó•" : diff < 604800000 ? "‰ªäÈÄ±" : "„Åù„Çå‰ª•Ââç";
    if (lb !== prev) { html += '<div class="sb-label">' + lb + '</div>'; prev = lb }
    var ac = s.sessionKey === curSession ? " active" : "";
    html += '<div class="sb-item' + ac + '" onclick="openSession(\'' + esc(s.sessionKey) + '\')">' + esc(s.title || "„ÉÅ„É£„ÉÉ„Éà") + '</div>';
  });
  el.innerHTML = html;
}

function openSession(k) { curSession = k; renderSB(); showChat(); loadHistory(k); closeSB() }

async function loadHistory(k) {
  var m = document.getElementById("messages");
  m.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text3);font-family:JetBrains Mono,monospace;font-size:12px">loading...</div>';
  try {
    var d = await api("/api/local/chat/history?sessionKey=" + encodeURIComponent(k));
    var msgs = d.messages || [];
    if (msgs.length > 0) {
      var title = msgs.find(function(x){ return x.role === "user" });
      if (title) {
        var t = title.content.slice(0, 30) + (title.content.length > 30 ? "..." : "");
        document.getElementById("topTitle").textContent = t;
      }
    }
    m.innerHTML = msgs.map(renderMsg).join("");
    m.scrollTop = m.scrollHeight;
  } catch(e) { m.innerHTML = '<div style="padding:40px;text-align:center;color:#ef4444;font-size:13px">Ë™≠„ÅøËæº„ÅøÂ§±Êïó</div>' }
}

function renderMsg(msg) {
  if (msg.role === "system") return "";
  var isU = msg.role === "user";
  var cls = isU ? "user" : "assistant";
  var icon = isU ? '<div class="msg-icon u">You</div>' : '<div class="msg-icon a">ü¶û</div>';
  var body = fmt(msg.content || "");
  if (!body) return "";
  var t = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString("ja-JP", { hour: "2-digit", minute: "2-digit" }) : "";
  return '<div class="msg-wrap ' + cls + '"><div class="msg-inner">' + icon + '<div class="msg-content"><div>' + body + '</div>' + (t ? '<div class="msg-time">' + t + '</div>' : '') + '</div></div></div>';
}

async function send() {
  var inp = document.getElementById("chatInput");
  var txt = inp.value.trim();
  if (!txt || busy) return;
  busy = true;
  currentActivities = [];
  document.getElementById("sendBtn").disabled = true;
  inp.value = ""; ar(inp);

  if (!curSession) { curSession = null; showChat(); }

  var m = document.getElementById("messages");
  m.innerHTML += renderMsg({ role: "user", content: txt, timestamp: new Date().toISOString() });
  // Add typing indicator
  m.innerHTML += '<div class="msg-wrap assistant" id="typing"><div class="msg-inner"><div class="msg-icon a">ü¶û</div><div class="msg-content"><div class="typing-dots"><span></span><span></span><span></span></div></div></div></div>';
  m.scrollTop = m.scrollHeight;

  try {
    var res = await fetch("/api/local/chat/send", {
      method: "POST",
      headers: { "Authorization": "Bearer " + T, "Content-Type": "application/json" },
      body: JSON.stringify({ message: txt, sessionKey: curSession, model: currentModel })
    });

    var reader = res.body.getReader();
    var decoder = new TextDecoder();
    var fullText = "";
    var typing = document.getElementById("typing");

    while (true) {
      var result = await reader.read();
      if (result.done) break;
      var chunk = decoder.decode(result.value, { stream: true });
      var lines = chunk.split("\n");

      for (var i = 0; i < lines.length; i++) {
        var line = lines[i].trim();
        if (!line.startsWith("data: ")) continue;
        var jsonStr = line.slice(6);
        if (jsonStr === "[DONE]") continue;
        try {
          var data = JSON.parse(jsonStr);
          // Capture sessionKey and orchestrator info from first message
          if (data.sessionKey && !curSession) {
            curSession = data.sessionKey;
          } else if (data.sessionKey && curSession === null) {
            curSession = data.sessionKey;
          }
          // Show orchestrator model selection
          if (data.orchestrator && typing) {
            var catIcons = { agent: "ü§ñ", coding: "üíª", reasoning: "üß†", chat: "üí¨", manual: "üéØ", browser: "üñ•Ô∏è" };
            var orchIcon = catIcons[data.orchestrator.category] || "ü§ñ";
            var orchLabel = '<div class="orch-label">' + orchIcon + ' ' + esc(data.orchestrator.model) + ' <span class="orch-reason">' + esc(data.orchestrator.reason) + '</span></div>';
            typing.querySelector(".msg-content").insertAdjacentHTML("afterbegin", orchLabel);
          }
          // Agent activity event ‚Äî Claude Code style progress
          if (data.type === "agent_activity") {
            if (typing && data.status !== "done") {
              currentActivities.push(parseActivityInfo(data));
              var orchEl = typing.querySelector(".orch-label");
              var orchHtml = orchEl ? orchEl.outerHTML : "";
              var progressHtml = renderProgressPanel(currentActivities, false);
              var textHtml = fullText ? '<div>' + fmt(fullText) + '</div>' : '<div class="typing-dots"><span></span><span></span><span></span></div>';
              typing.querySelector(".msg-content").innerHTML = orchHtml + progressHtml + textHtml;
              m.scrollTop = m.scrollHeight;
            }
          }
          if (data.content) {
            fullText += data.content;
            if (typing) {
              var orchEl = typing.querySelector(".orch-label");
              var orchHtml = orchEl ? orchEl.outerHTML : "";
              var progressHtml = renderProgressPanel(currentActivities, true);
              typing.querySelector(".msg-content").innerHTML = orchHtml + progressHtml + '<div>' + fmt(fullText) + '</div>';
              m.scrollTop = m.scrollHeight;
            }
          }
          if (data.done) {
            if (typing) {
              // Final render with all activities marked done
              var orchEl = typing.querySelector(".orch-label");
              var orchHtml = orchEl ? orchEl.outerHTML : "";
              var progressHtml = renderProgressPanel(currentActivities, true);
              var textHtml = fullText ? '<div>' + fmt(fullText) + '</div>' : '';
              typing.querySelector(".msg-content").innerHTML = orchHtml + progressHtml + textHtml;
              typing.id = "";
            }
            currentActivities = [];
            if (txt) {
              var tt = txt.slice(0, 30) + (txt.length > 30 ? "..." : "");
              document.getElementById("topTitle").textContent = tt;
            }
            // Auto-refresh workspace bar after agent operations
            loadWorkspaceStatus();
          }
          if (data.error) {
            if (typing) {
              typing.querySelector(".msg-content").innerHTML = '<div style="color:#ef4444">' + esc(data.error) + '</div>';
              typing.id = "";
            }
          }
        } catch(e) {}
      }
    }
  } catch(e) {
    var typing = document.getElementById("typing");
    if (typing) { typing.querySelector(".msg-content").innerHTML = '<div style="color:#ef4444">ÈÄÅ‰ø°„Ç®„É©„Éº: ' + esc(e.message) + '</div>'; typing.id = ""; }
  }

  busy = false;
  document.getElementById("sendBtn").disabled = false;
  attachedFiles = [];
  document.getElementById("filePreview").innerHTML = "";
  loadSessions(); // Refresh sidebar
}

function showChat() { document.getElementById("welcome").classList.add("hidden"); var m = document.getElementById("messages"); m.classList.add("show"); document.getElementById("chatInput").focus() }
function clearMessages() { document.getElementById("messages").innerHTML = "" }
function showWelcome() { document.getElementById("welcome").classList.remove("hidden"); document.getElementById("messages").classList.remove("show"); document.getElementById("messages").innerHTML = ""; document.getElementById("topTitle").textContent = "Êñ∞„Åó„ÅÑ„ÉÅ„É£„ÉÉ„Éà" }
function newChat() { curSession = null; renderSB(); showWelcome(); closeSB(); document.getElementById("chatInput").focus() }

function hk(e) { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); send() } }
function ar(el) { el.style.height = "auto"; el.style.height = Math.min(el.scrollHeight, 200) + "px" }
function toggleSB() { document.getElementById("sidebar").classList.toggle("open"); document.getElementById("overlay").classList.toggle("show") }
function closeSB() { document.getElementById("sidebar").classList.remove("open"); document.getElementById("overlay").classList.remove("show") }
function esc(s) { var d = document.createElement("div"); d.textContent = s; return d.innerHTML }
function fmt(t) {
  var h = esc(t);
  // 1. Extract code blocks (preserve from further processing)
  var codeBlocks = [];
  h = h.replace(/```(\w*)\n([\s\S]*?)```/g, function(m, lang, code) {
    codeBlocks.push('<pre><code>' + code + '</code></pre>');
    return '\n%%CB' + (codeBlocks.length - 1) + '%%\n';
  });
  // 2. Headers
  h = h.replace(/^### (.+)$/gm, '<h4 class="md-h">$1</h4>');
  h = h.replace(/^## (.+)$/gm, '<h3 class="md-h">$1</h3>');
  h = h.replace(/^# (.+)$/gm, '<h2 class="md-h">$1</h2>');
  // 3. Unordered lists (group consecutive - or * lines)
  h = h.replace(/((?:^[-*] .+\n?)+)/gm, function(block) {
    var items = block.trim().split('\n').map(function(l) { return '<li>' + l.replace(/^[-*] /, '') + '</li>'; });
    return '<ul class="md-list">' + items.join('') + '</ul>\n';
  });
  // 4. Ordered lists
  h = h.replace(/((?:^\d+\. .+\n?)+)/gm, function(block) {
    var items = block.trim().split('\n').map(function(l) { return '<li>' + l.replace(/^\d+\. /, '') + '</li>'; });
    return '<ol class="md-list">' + items.join('') + '</ol>\n';
  });
  // 5. Inline code
  h = h.replace(/`([^`]+)`/g, '<code>$1</code>');
  // 6. Bold, italic
  h = h.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
  h = h.replace(/(?:^|\s)\*([^*]+)\*(?:\s|$)/g, ' <em>$1</em> ');
  // 7. Links
  h = h.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a class="md-link" href="$2" target="_blank">$1</a>');
  // 8. Line breaks (but not inside block elements)
  h = h.replace(/\n/g, '<br>');
  // 9. Clean up extra <br> around block elements
  h = h.replace(/<br>\s*(<(?:ul|ol|h[234]|pre))/g, '$1');
  h = h.replace(/(<\/(?:ul|ol|h[234]|pre)>)\s*<br>/g, '$1');
  // 10. Restore code blocks
  codeBlocks.forEach(function(block, i) { h = h.replace('%%CB' + i + '%%', block); });
  return h;
}
function triggerFile() { document.getElementById("fileInput").click() }
function handleFiles(input) { for (var i = 0; i < input.files.length; i++) attachedFiles.push(input.files[i]); renderFP(); input.value = "" }
function renderFP() { document.getElementById("filePreview").innerHTML = attachedFiles.map(function(f, i) { return '<div class="file-tag">üìé ' + esc(f.name) + ' <span class="rm" onclick="rmFile(' + i + ')">√ó</span></div>' }).join("") }
function rmFile(i) { attachedFiles.splice(i, 1); renderFP() }
function toggleModel() { var mp = document.getElementById("modelPopup"); var btn = document.getElementById("modelBtn"); var r = btn.getBoundingClientRect(); mp.style.bottom = (window.innerHeight - r.top + 8) + "px"; mp.style.right = (window.innerWidth - r.right) + "px"; mp.classList.toggle("show") }
function setModel(id, el) { currentModel = id; document.getElementById("modelLabel").textContent = id === "auto" ? "ü§ñ auto" : id; document.querySelectorAll(".mp-item").forEach(function(e) { e.classList.remove("active") }); el.classList.add("active"); document.getElementById("modelPopup").classList.remove("show") }
function doLogout() { localStorage.removeItem("token"); localStorage.removeItem("email"); location.href = "/app.html" }
function insertPrompt(text) { var inp = document.getElementById("chatInput"); inp.value = text; inp.focus(); ar(inp) }
function parseActivityInfo(data) {
  var tool = data.tool || "tool";
  var label = "Âá¶ÁêÜ‰∏≠";
  if (tool === "browser" && data.params && data.params.action) {
    var ba = { snapshot: "„Éö„Éº„Ç∏Ëß£Êûê", thinking: "Âà§Êñ≠‰∏≠", navigate: "„Éö„Éº„Ç∏ÁßªÂãï", click: "„ÇØ„É™„ÉÉ„ÇØ", type: "„ÉÜ„Ç≠„Çπ„ÉàÂÖ•Âäõ", scroll: "„Çπ„ÇØ„É≠„Éº„É´", wait: "ÂæÖÊ©ü‰∏≠" };
    label = ba[data.params.action] || data.params.action;
    if (data.params.action.includes("„Éñ„É©„Ç¶„Ç∂")) label = data.params.action;
  } else if (tool === "agent" && data.params && data.params.action) {
    var ca = { planning: "„Çø„Çπ„ÇØÂàÜÊûê", thinking: "Âà§Êñ≠‰∏≠", file_write: "„Éï„Ç°„Ç§„É´Êõ∏„ÅçËæº„Åø", file_edit: "„Éï„Ç°„Ç§„É´Á∑®ÈõÜ", file_read: "„Éï„Ç°„Ç§„É´Ë™≠„ÅøÂèñ„Çä", list_files: "„Éï„Ç°„Ç§„É´‰∏ÄË¶ß", grep: "„Ç≥„Éº„ÉâÊ§úÁ¥¢", shell: "„Ç≥„Éû„É≥„ÉâÂÆüË°å", search: "Ê§úÁ¥¢" };
    label = ca[data.params.action] || data.params.action;
  } else {
    var tl = { web_fetch: "„Ç¶„Çß„ÉñÂèñÂæó", shell: "„Ç≥„Éû„É≥„ÉâÂÆüË°å", read_file: "„Éï„Ç°„Ç§„É´Ë™≠„ÅøÂèñ„Çä", browser: "„Éñ„É©„Ç¶„Ç∂Êìç‰Ωú", search: "Ê§úÁ¥¢", agent: "„Ç®„Éº„Ç∏„Çß„É≥„Éà" };
    label = tl[tool] || tool;
  }
  var detail = (data.params && data.params.detail) ? data.params.detail : "";
  return { label: label, detail: detail };
}
function renderProgressPanel(activities, allDone) {
  if (!activities.length) return "";
  var doneClass = allDone ? " all-done" : "";
  var MAX_VISIBLE = 4;
  var hidden = 0;
  var visible = activities;
  if (allDone && activities.length > MAX_VISIBLE) {
    hidden = activities.length - MAX_VISIBLE;
    visible = activities.slice(-MAX_VISIBLE);
  } else if (!allDone && activities.length > MAX_VISIBLE + 1) {
    hidden = activities.length - MAX_VISIBLE - 1;
    visible = activities.slice(-MAX_VISIBLE - 1);
  }
  var lines = [];
  if (hidden > 0) {
    lines.push('<div class="ap-step"><span class="ap-mark" style="opacity:.3">‚ãØ</span><span style="opacity:.4">' + hidden + ' „Çπ„ÉÜ„ÉÉ„ÉóÂÆå‰∫Ü</span></div>');
  }
  visible.forEach(function(a, i) {
    var isLast = (i === visible.length - 1);
    var done = allDone || !isLast;
    var cls = done ? "ap-step" : "ap-step active";
    var mark = done ? '<span style="opacity:.4">‚úì</span>' : '<span class="ap-spin"></span>';
    var detail = a.detail ? '<span class="ap-detail">' + esc(a.detail) + '</span>' : "";
    lines.push('<div class="' + cls + '"><span class="ap-mark">' + mark + '</span><span>' + esc(a.label) + '</span>' + detail + '</div>');
  });
  return '<div class="agent-progress' + doneClass + '">' + lines.join("") + '</div>';
}
function showChatHelp() { document.getElementById("chatHelpPopup").classList.add("show"); document.getElementById("chatHelpOverlay").classList.add("show"); closeSB() }
function closeChatHelp() { document.getElementById("chatHelpPopup").classList.remove("show"); document.getElementById("chatHelpOverlay").classList.remove("show") }
document.addEventListener("click", function(e) { var mp = document.getElementById("modelPopup"), mb = document.getElementById("modelBtn"); if (!mp.contains(e.target) && !mb.contains(e.target)) mp.classList.remove("show") });

init();
</script>
</body>
</html>
