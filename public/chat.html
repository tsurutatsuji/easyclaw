<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>EasyClaw Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700&family=JetBrains+Mono:wght@300;400;500&family=Noto+Sans+JP:wght@200;300;400;500;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
--black:#050505;--dark:#0a0a0a;--dark2:#111;--dark3:#1a1a1a;--dark4:#222;
--text:#e8e8e8;--text2:#888;--text3:#555;
--green:#00ff41;--green2:#00cc33;--greenDim:rgba(0,255,65,0.08);--greenGlow:rgba(0,255,65,0.15);
--accent:#e8562a;--accent2:#ff7040;
}
html,body{height:100%;font-family:'Inter','Noto Sans JP',-apple-system,sans-serif;background:var(--black);color:var(--text);overflow:hidden;-webkit-font-smoothing:antialiased}
::selection{background:var(--greenGlow);color:var(--green)}
.app{display:flex;height:100vh;height:100dvh}

/* Sidebar */
.sidebar{width:260px;min-width:260px;background:var(--dark);display:flex;flex-direction:column;border-right:1px solid rgba(255,255,255,0.04);z-index:20;transition:transform .25s;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
.sb-top{padding:12px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,0.04)}
.sb-logo{font-size:14px;font-weight:600;display:flex;align-items:center;gap:6px;text-decoration:none;color:var(--text)}
.sb-logo span{color:var(--green);font-size:11px;font-weight:400;font-family:'JetBrains Mono',monospace}
.sb-new{width:32px;height:32px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all .15s}
.sb-new:hover{background:rgba(0,255,65,0.05);color:var(--green);border-color:rgba(0,255,65,0.2)}
.sb-sessions{flex:1;overflow-y:auto;padding:4px 8px}
.sb-sessions::-webkit-scrollbar{width:3px}
.sb-sessions::-webkit-scrollbar-thumb{background:var(--dark4);border-radius:3px}
.sb-label{font-size:9px;font-weight:500;color:var(--text3);padding:12px 8px 4px;text-transform:uppercase;letter-spacing:1.2px;font-family:'JetBrains Mono',monospace}
.sb-item{padding:8px 10px;border-radius:8px;cursor:pointer;margin-bottom:1px;font-size:13px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;transition:all .15s}
.sb-item:hover{background:rgba(255,255,255,0.03);color:var(--text)}
.sb-item.active{background:rgba(0,255,65,0.05);color:var(--green);border-left:2px solid var(--green);padding-left:8px}
.sb-footer{padding:10px 12px;border-top:1px solid rgba(255,255,255,0.04);display:flex;flex-direction:column;gap:2px}
.sb-footer a{display:flex;align-items:center;gap:6px;color:var(--text3);font-size:12px;text-decoration:none;padding:6px 8px;border-radius:6px;transition:all .15s}
.sb-footer a:hover{color:var(--green);background:rgba(0,255,65,0.03)}

/* Main */
.main{flex:1;display:flex;flex-direction:column;min-width:0;position:relative}
.topbar{height:48px;display:flex;align-items:center;justify-content:space-between;padding:0 20px;border-bottom:1px solid rgba(255,255,255,0.04);flex-shrink:0;backdrop-filter:blur(10px);background:rgba(5,5,5,0.8)}
.tb-left{display:flex;align-items:center;gap:8px}
.menu-btn{display:none;background:none;border:none;color:var(--text2);cursor:pointer;padding:4px}
.menu-btn svg{width:18px;height:18px}
.tb-title{font-size:13px;font-weight:500;color:var(--text)}
.tb-right{display:flex;align-items:center;gap:8px}
.tb-status{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--text3);font-family:'JetBrains Mono',monospace}
.tb-dot{width:6px;height:6px;border-radius:50%;background:var(--green);box-shadow:0 0 8px rgba(0,255,65,0.4)}
.tb-dot.off{background:#ef4444;box-shadow:0 0 8px rgba(239,68,68,0.4)}

/* Content */
.content-area{flex:1;display:flex;flex-direction:column;min-height:0}
.welcome{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 24px}
.welcome.hidden{display:none}
.w-icon{font-size:40px;margin-bottom:16px;opacity:.6}
.w-title{font-family:'Playfair Display',serif;font-size:24px;font-weight:500;margin-bottom:8px;letter-spacing:-.3px}
.w-sub{font-size:14px;color:var(--text3);font-weight:300}

/* Messages */
.messages{flex:1;overflow-y:auto;padding:20px 0;display:none}
.messages.show{display:block}
.messages::-webkit-scrollbar{width:4px}
.messages::-webkit-scrollbar-thumb{background:var(--dark4);border-radius:4px}
.msg-wrap{padding:18px 0}
.msg-wrap.assistant{background:rgba(255,255,255,0.01)}
.msg-inner{max-width:700px;margin:0 auto;padding:0 24px;display:flex;gap:12px}
.msg-wrap.user .msg-inner{flex-direction:row-reverse}
.msg-icon{width:26px;height:26px;border-radius:8px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:12px;margin-top:2px}
.msg-icon.u{background:var(--accent);color:#fff;font-weight:600;font-size:9px;letter-spacing:.5px}
.msg-icon.a{background:rgba(0,255,65,0.08);color:var(--green);font-size:14px;border:1px solid rgba(0,255,65,0.1)}
.msg-content{flex:1;min-width:0;font-size:14px;line-height:1.8;font-weight:400;color:var(--text)}
.msg-wrap.user .msg-content{text-align:left}
.msg-content p{margin-bottom:8px}.msg-content p:last-child{margin-bottom:0}
.msg-content strong{font-weight:600;color:var(--text)}
.msg-content code{font-family:'JetBrains Mono',monospace;font-size:12px;background:rgba(0,255,65,0.05);border:1px solid rgba(0,255,65,0.08);padding:1px 6px;border-radius:4px;color:var(--green)}
.msg-content pre{background:var(--dark);border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:16px;margin:12px 0;overflow-x:auto;font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.7}
.msg-content pre code{background:none;border:none;padding:0;color:var(--text)}
.msg-time{font-size:10px;color:var(--text3);margin-top:6px;font-family:'JetBrains Mono',monospace}
.msg-wrap.user .msg-time{text-align:right}

/* Input */
.input-area{padding:12px 24px 20px;flex-shrink:0}
.input-box{max-width:700px;margin:0 auto;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:16px;overflow:hidden;transition:all .2s;backdrop-filter:blur(10px)}
.input-box:focus-within{border-color:rgba(0,255,65,0.2);box-shadow:0 0 0 3px rgba(0,255,65,0.03)}
.input-box textarea{width:100%;min-height:44px;max-height:200px;background:transparent;border:none;padding:14px 18px 8px;color:var(--text);font-size:14px;font-family:inherit;resize:none;outline:none;line-height:1.5}
.input-box textarea::placeholder{color:var(--text3)}
.input-toolbar{display:flex;align-items:center;justify-content:space-between;padding:4px 8px 8px}
.input-toolbar-left{display:flex;align-items:center;gap:2px}
.input-toolbar-right{display:flex;align-items:center;gap:6px}
.tb-btn{width:32px;height:32px;border-radius:8px;border:none;background:transparent;color:var(--text3);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.tb-btn:hover{background:rgba(255,255,255,0.04);color:var(--text2)}
.tb-btn svg{width:18px;height:18px}
.model-btn{display:flex;align-items:center;gap:4px;padding:4px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text3);cursor:pointer;font-size:11px;font-family:'JetBrains Mono',monospace;transition:all .15s}
.model-btn:hover{background:rgba(0,255,65,0.03);border-color:rgba(0,255,65,0.15);color:var(--green)}
.send-btn{width:34px;height:34px;border-radius:10px;border:none;background:var(--accent);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.send-btn:hover{background:var(--accent2);transform:translateY(-1px);box-shadow:0 4px 15px rgba(232,86,42,0.3)}
.send-btn:disabled{opacity:.3;cursor:not-allowed;transform:none;box-shadow:none}
.send-btn svg{width:16px;height:16px}

.file-preview{display:flex;gap:6px;padding:4px 12px;flex-wrap:wrap}
.file-tag{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:8px;font-size:11px;color:var(--text2)}
.file-tag .rm{cursor:pointer;opacity:.5;font-size:13px}.file-tag .rm:hover{opacity:1;color:#ef4444}

.typing-dots{display:inline-flex;gap:3px;padding:2px 0}
.typing-dots span{width:5px;height:5px;border-radius:50%;background:var(--green);animation:pulse 1.4s infinite both}
.typing-dots span:nth-child(2){animation-delay:.2s}
.typing-dots span:nth-child(3){animation-delay:.4s}
@keyframes pulse{0%,80%,100%{opacity:.2;transform:scale(.8)}40%{opacity:1;transform:scale(1)}}

/* Model Popup */
.model-popup{display:none;position:fixed;background:var(--dark);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:6px;min-width:240px;box-shadow:0 16px 48px rgba(0,0,0,0.6);z-index:99999;backdrop-filter:blur(20px)}
.model-popup.show{display:block}
.mp-section{padding:6px 12px 4px;font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:1.2px;font-family:'JetBrains Mono',monospace}
.mp-section:not(:first-child){border-top:1px solid rgba(255,255,255,0.04);margin-top:4px;padding-top:10px}
.mp-item{padding:8px 12px;border-radius:8px;font-size:13px;color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:space-between;transition:all .1s}
.mp-item:hover{background:rgba(0,255,65,0.03);color:var(--text)}
.mp-item.active{color:var(--green)}
.mp-item .ck{display:none;color:var(--green);font-size:12px}.mp-item.active .ck{display:inline}

.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:15}
.overlay.show{display:block}

@media(max-width:768px){
.sidebar{position:fixed;left:0;top:0;bottom:0;transform:translateX(-100%)}
.sidebar.open{transform:translateX(0)}
.menu-btn{display:flex}
.msg-inner{padding:0 16px}
.input-area{padding:8px 12px 12px}
}
</style>
</head>
<body>
<div class="app">
<div class="overlay" id="overlay" onclick="toggleSB()"></div>
<div class="sidebar" id="sidebar">
<div class="sb-top"><a href="/" class="sb-logo">ü¶û EasyClaw <span>chat</span></a><button class="sb-new" onclick="newChat()" title="Êñ∞„Åó„ÅÑ„ÉÅ„É£„ÉÉ„Éà">+</button></div>
<div class="sb-sessions" id="sessionList"></div>
<div class="sb-footer">
<a href="/setup.html"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>Ë®≠ÂÆö</a>
<a onclick="doLogout()" style="cursor:pointer"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"/></svg>„É≠„Ç∞„Ç¢„Ç¶„Éà</a>
</div>
</div>
<div class="main">
<div class="topbar">
<div class="tb-left">
<button class="menu-btn" onclick="toggleSB()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="15" y2="12"/><line x1="3" y1="18" x2="18" y2="18"/></svg></button>
<span class="tb-title" id="topTitle">Êñ∞„Åó„ÅÑ„ÉÅ„É£„ÉÉ„Éà</span>
</div>
<div class="tb-right"><div class="tb-status"><span class="tb-dot" id="statusDot"></span><span id="statusText">Êé•Á∂ö‰∏≠</span></div></div>
</div>
<div class="content-area">
<div class="welcome" id="welcome">
<div class="w-icon">ü¶û</div>
<div class="w-title" id="greeting"></div>
<div class="w-sub">‰Ωï„Åß„ÇÇËÅû„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ</div>
</div>
<div class="messages" id="messages"></div>
</div>
<div class="input-area">
<div class="input-box">
<div class="file-preview" id="filePreview"></div>
<textarea id="chatInput" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ..." rows="1" onkeydown="hk(event)" oninput="ar(this)"></textarea>
<div class="input-toolbar">
<div class="input-toolbar-left">
<button class="tb-btn" onclick="triggerFile()" title="„Éï„Ç°„Ç§„É´Ê∑ª‰ªò"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg></button>
</div>
<div class="input-toolbar-right">
<button class="model-btn" id="modelBtn" onclick="toggleModel()"><span id="modelLabel">...</span> <span style="font-size:10px">‚ñæ</span></button>
<button class="send-btn" id="sendBtn" onclick="send()"><svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="model-popup" id="modelPopup"></div>
<input type="file" id="fileInput" style="display:none" multiple accept="image/*,.pdf,.txt,.csv,.json,.md" onchange="handleFiles(this)">
<script>
var T = localStorage.getItem("token");
if (!T) location.href = "/app.html";

var curSession = null, sessions = [], busy = false, attachedFiles = [], currentModel = "", userSettings = null;

function api(u, o) { o = o || {}; o.headers = Object.assign({ "Authorization": "Bearer " + T, "Content-Type": "application/json" }, o.headers || {}); return fetch(u, o).then(function(r) { return r.json() }) }

async function init() {
  setGreeting();
  await loadSettings();
  await checkHealth();
  await loadSessions();
  document.getElementById("chatInput").focus();
}

function setGreeting() { var h = new Date().getHours(); document.getElementById("greeting").textContent = h < 5 ? "„Åì„Çì„Å∞„Çì„ÅØ" : h < 12 ? "„Åä„ÅØ„Çà„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô" : h < 18 ? "„Åì„Çì„Å´„Å°„ÅØ" : "„Åì„Çì„Å∞„Çì„ÅØ" }

async function loadSettings() {
  try {
    var d = await api("/api/settings");
    userSettings = d.settings;
    currentModel = userSettings.model || "llama3.2";
    document.getElementById("modelLabel").textContent = currentModel;
    buildModelPopup();
  } catch(e) {
    currentModel = "llama3.2";
    document.getElementById("modelLabel").textContent = currentModel;
  }
}

async function buildModelPopup() {
  var popup = document.getElementById("modelPopup");
  var html = "";

  if (!userSettings || userSettings.provider === "ollama") {
    html += '<div class="mp-section">Ollama (Local)</div>';
    try {
      var d = await api("/api/ollama/models");
      if (d.success && d.models.length > 0) {
        d.models.forEach(function(m) {
          var active = m.name === currentModel ? " active" : "";
          html += '<div class="mp-item' + active + '" onclick="setModel(\'' + m.name + '\',this)">' + m.name + '<span class="ck">‚úì</span></div>';
        });
      } else {
        html += '<div class="mp-item" style="color:var(--text3);cursor:default">„É¢„Éá„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</div>';
      }
    } catch(e) {
      html += '<div class="mp-item" style="color:var(--text3);cursor:default">OllamaÊú™Êé•Á∂ö</div>';
    }
  } else {
    var models = {
      google: [["google/gemini-2.5-flash","Gemini 2.5 Flash"],["google/gemini-2.5-pro","Gemini 2.5 Pro"]],
      anthropic: [["anthropic/claude-sonnet-4-5-20250929","Claude Sonnet 4.5"],["anthropic/claude-haiku-4-5-20251001","Claude Haiku 4.5"]],
      openai: [["openai/gpt-4o","GPT-4o"],["openai/gpt-4o-mini","GPT-4o Mini"]]
    };
    var provider = userSettings.provider;
    var names = { google: "Google", anthropic: "Anthropic", openai: "OpenAI" };
    html += '<div class="mp-section">' + (names[provider] || provider) + '</div>';
    (models[provider] || []).forEach(function(m) {
      var active = m[0] === currentModel ? " active" : "";
      html += '<div class="mp-item' + active + '" onclick="setModel(\'' + m[0] + '\',this)">' + m[1] + '<span class="ck">‚úì</span></div>';
    });
  }
  popup.innerHTML = html;
}

async function checkHealth() {
  try {
    if (!userSettings || userSettings.provider === "ollama") {
      var h = await api("/api/ollama/health");
      if (h.ok) { document.getElementById("statusDot").className = "tb-dot"; document.getElementById("statusText").textContent = "OllamaÊé•Á∂ö‰∏≠"; }
      else throw 0;
    } else {
      document.getElementById("statusDot").className = "tb-dot";
      document.getElementById("statusText").textContent = "APIÊé•Á∂ö‰∏≠";
    }
  } catch(e) { document.getElementById("statusDot").className = "tb-dot off"; document.getElementById("statusText").textContent = "„Ç™„Éï„É©„Ç§„É≥"; }
}

async function loadSessions() {
  try {
    var d = await api("/api/local/chat/sessions");
    sessions = d.sessions || [];
    renderSB();
  } catch(e) {}
}

function renderSB() {
  var el = document.getElementById("sessionList");
  if (!sessions.length) { el.innerHTML = '<div style="padding:24px 12px;text-align:center;color:var(--text3);font-size:12px;font-family:JetBrains Mono,monospace">No chats yet</div>'; return }
  var now = Date.now(), html = "", prev = "";
  sessions.forEach(function(s) {
    var ts = new Date(s.updatedAt || s.createdAt).getTime();
    var diff = now - ts;
    var lb = diff < 86400000 ? "‰ªäÊó•" : diff < 172800000 ? "Êò®Êó•" : diff < 604800000 ? "‰ªäÈÄ±" : "„Åù„Çå‰ª•Ââç";
    if (lb !== prev) { html += '<div class="sb-label">' + lb + '</div>'; prev = lb }
    var ac = s.sessionKey === curSession ? " active" : "";
    html += '<div class="sb-item' + ac + '" onclick="openSession(\'' + esc(s.sessionKey) + '\')">' + esc(s.title || "„ÉÅ„É£„ÉÉ„Éà") + '</div>';
  });
  el.innerHTML = html;
}

function openSession(k) { curSession = k; renderSB(); showChat(); loadHistory(k); closeSB() }

async function loadHistory(k) {
  var m = document.getElementById("messages");
  m.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text3);font-family:JetBrains Mono,monospace;font-size:12px">loading...</div>';
  try {
    var d = await api("/api/local/chat/history?sessionKey=" + encodeURIComponent(k));
    var msgs = d.messages || [];
    if (msgs.length > 0) {
      var title = msgs.find(function(x){ return x.role === "user" });
      if (title) {
        var t = title.content.slice(0, 30) + (title.content.length > 30 ? "..." : "");
        document.getElementById("topTitle").textContent = t;
      }
    }
    m.innerHTML = msgs.map(renderMsg).join("");
    m.scrollTop = m.scrollHeight;
  } catch(e) { m.innerHTML = '<div style="padding:40px;text-align:center;color:#ef4444;font-size:13px">Ë™≠„ÅøËæº„ÅøÂ§±Êïó</div>' }
}

function renderMsg(msg) {
  if (msg.role === "system") return "";
  var isU = msg.role === "user";
  var cls = isU ? "user" : "assistant";
  var icon = isU ? '<div class="msg-icon u">You</div>' : '<div class="msg-icon a">ü¶û</div>';
  var body = fmt(msg.content || "");
  if (!body) return "";
  var t = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString("ja-JP", { hour: "2-digit", minute: "2-digit" }) : "";
  return '<div class="msg-wrap ' + cls + '"><div class="msg-inner">' + icon + '<div class="msg-content"><div>' + body + '</div>' + (t ? '<div class="msg-time">' + t + '</div>' : '') + '</div></div></div>';
}

async function send() {
  var inp = document.getElementById("chatInput");
  var txt = inp.value.trim();
  if (!txt || busy) return;
  busy = true;
  document.getElementById("sendBtn").disabled = true;
  inp.value = ""; ar(inp);

  if (!curSession) { curSession = null; showChat(); }

  var m = document.getElementById("messages");
  m.innerHTML += renderMsg({ role: "user", content: txt, timestamp: new Date().toISOString() });
  // Add typing indicator
  m.innerHTML += '<div class="msg-wrap assistant" id="typing"><div class="msg-inner"><div class="msg-icon a">ü¶û</div><div class="msg-content"><div class="typing-dots"><span></span><span></span><span></span></div></div></div></div>';
  m.scrollTop = m.scrollHeight;

  try {
    var res = await fetch("/api/local/chat/send", {
      method: "POST",
      headers: { "Authorization": "Bearer " + T, "Content-Type": "application/json" },
      body: JSON.stringify({ message: txt, sessionKey: curSession, model: currentModel })
    });

    var reader = res.body.getReader();
    var decoder = new TextDecoder();
    var fullText = "";
    var typing = document.getElementById("typing");

    while (true) {
      var result = await reader.read();
      if (result.done) break;
      var chunk = decoder.decode(result.value, { stream: true });
      var lines = chunk.split("\n");

      for (var i = 0; i < lines.length; i++) {
        var line = lines[i].trim();
        if (!line.startsWith("data: ")) continue;
        var jsonStr = line.slice(6);
        if (jsonStr === "[DONE]") continue;
        try {
          var data = JSON.parse(jsonStr);
          // Capture sessionKey from first message
          if (data.sessionKey && !curSession) {
            curSession = data.sessionKey;
          } else if (data.sessionKey && curSession === null) {
            curSession = data.sessionKey;
          }
          if (data.content) {
            fullText += data.content;
            if (typing) {
              typing.querySelector(".msg-content").innerHTML = '<div>' + fmt(fullText) + '</div>';
              m.scrollTop = m.scrollHeight;
            }
          }
          if (data.done) {
            if (typing) typing.id = "";
            // Set title from first user message
            if (txt) {
              var tt = txt.slice(0, 30) + (txt.length > 30 ? "..." : "");
              document.getElementById("topTitle").textContent = tt;
            }
          }
          if (data.error) {
            if (typing) {
              typing.querySelector(".msg-content").innerHTML = '<div style="color:#ef4444">' + esc(data.error) + '</div>';
              typing.id = "";
            }
          }
        } catch(e) {}
      }
    }
  } catch(e) {
    var typing = document.getElementById("typing");
    if (typing) { typing.querySelector(".msg-content").innerHTML = '<div style="color:#ef4444">ÈÄÅ‰ø°„Ç®„É©„Éº: ' + esc(e.message) + '</div>'; typing.id = ""; }
  }

  busy = false;
  document.getElementById("sendBtn").disabled = false;
  attachedFiles = [];
  document.getElementById("filePreview").innerHTML = "";
  loadSessions(); // Refresh sidebar
}

function showChat() { document.getElementById("welcome").classList.add("hidden"); var m = document.getElementById("messages"); m.classList.add("show"); document.getElementById("chatInput").focus() }
function clearMessages() { document.getElementById("messages").innerHTML = "" }
function showWelcome() { document.getElementById("welcome").classList.remove("hidden"); document.getElementById("messages").classList.remove("show"); document.getElementById("messages").innerHTML = ""; document.getElementById("topTitle").textContent = "Êñ∞„Åó„ÅÑ„ÉÅ„É£„ÉÉ„Éà" }
function newChat() { curSession = null; renderSB(); showWelcome(); closeSB(); document.getElementById("chatInput").focus() }

function hk(e) { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); send() } }
function ar(el) { el.style.height = "auto"; el.style.height = Math.min(el.scrollHeight, 200) + "px" }
function toggleSB() { document.getElementById("sidebar").classList.toggle("open"); document.getElementById("overlay").classList.toggle("show") }
function closeSB() { document.getElementById("sidebar").classList.remove("open"); document.getElementById("overlay").classList.remove("show") }
function esc(s) { var d = document.createElement("div"); d.textContent = s; return d.innerHTML }
function fmt(t) { var h = esc(t); h = h.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>'); h = h.replace(/`([^`]+)`/g, '<code>$1</code>'); h = h.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>'); h = h.replace(/\n/g, '<br>'); return h }
function triggerFile() { document.getElementById("fileInput").click() }
function handleFiles(input) { for (var i = 0; i < input.files.length; i++) attachedFiles.push(input.files[i]); renderFP(); input.value = "" }
function renderFP() { document.getElementById("filePreview").innerHTML = attachedFiles.map(function(f, i) { return '<div class="file-tag">üìé ' + esc(f.name) + ' <span class="rm" onclick="rmFile(' + i + ')">√ó</span></div>' }).join("") }
function rmFile(i) { attachedFiles.splice(i, 1); renderFP() }
function toggleModel() { var mp = document.getElementById("modelPopup"); var btn = document.getElementById("modelBtn"); var r = btn.getBoundingClientRect(); mp.style.bottom = (window.innerHeight - r.top + 8) + "px"; mp.style.right = (window.innerWidth - r.right) + "px"; mp.classList.toggle("show") }
function setModel(id, el) { currentModel = id; document.getElementById("modelLabel").textContent = id; document.querySelectorAll(".mp-item").forEach(function(e) { e.classList.remove("active") }); el.classList.add("active"); document.getElementById("modelPopup").classList.remove("show") }
function doLogout() { localStorage.removeItem("token"); localStorage.removeItem("email"); location.href = "/app.html" }
document.addEventListener("click", function(e) { var mp = document.getElementById("modelPopup"), mb = document.getElementById("modelBtn"); if (!mp.contains(e.target) && !mb.contains(e.target)) mp.classList.remove("show") });

init();
</script>
</body>
</html>
