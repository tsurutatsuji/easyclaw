<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>EasyClaw Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700&family=JetBrains+Mono:wght@300;400;500&family=Noto+Sans+JP:wght@200;300;400;500;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
--black:#050505;--dark:#0a0a0a;--dark2:#111;--dark3:#1a1a1a;--dark4:#222;
--text:#e8e8e8;--text2:#888;--text3:#555;
--green:#00ff41;--green2:#00cc33;--greenDim:rgba(0,255,65,0.08);--greenGlow:rgba(0,255,65,0.15);
--accent:#e8562a;--accent2:#ff7040;
}
html,body{height:100%;font-family:'Inter','Noto Sans JP',-apple-system,sans-serif;background:var(--black);color:var(--text);overflow:hidden;-webkit-font-smoothing:antialiased}
::selection{background:var(--greenGlow);color:var(--green)}
.app{display:flex;height:100vh;height:100dvh}

/* Sidebar */
.sidebar{width:260px;min-width:260px;background:var(--dark);display:flex;flex-direction:column;border-right:1px solid rgba(255,255,255,0.04);z-index:20;transition:transform .25s;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
.sb-top{padding:12px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,0.04)}
.sb-logo{font-size:14px;font-weight:600;display:flex;align-items:center;gap:6px;text-decoration:none;color:var(--text)}
.sb-logo span{color:var(--green);font-size:11px;font-weight:400;font-family:'JetBrains Mono',monospace}
.sb-new{width:32px;height:32px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all .15s}
.sb-new:hover{background:rgba(0,255,65,0.05);color:var(--green);border-color:rgba(0,255,65,0.2)}
.sb-sessions{flex:1;overflow-y:auto;padding:4px 8px}
.sb-sessions::-webkit-scrollbar{width:3px}
.sb-sessions::-webkit-scrollbar-thumb{background:var(--dark4);border-radius:3px}
.sb-label{font-size:9px;font-weight:500;color:var(--text3);padding:12px 8px 4px;text-transform:uppercase;letter-spacing:1.2px;font-family:'JetBrains Mono',monospace}
.sb-item{padding:8px 10px;border-radius:8px;cursor:pointer;margin-bottom:1px;font-size:13px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;transition:all .15s}
.sb-item:hover{background:rgba(255,255,255,0.03);color:var(--text)}
.sb-item.active{background:rgba(0,255,65,0.05);color:var(--green);border-left:2px solid var(--green);padding-left:8px}
.sb-footer{padding:10px 12px;border-top:1px solid rgba(255,255,255,0.04);display:flex;flex-direction:column;gap:2px}
.sb-footer a{display:flex;align-items:center;gap:6px;color:var(--text3);font-size:12px;text-decoration:none;padding:6px 8px;border-radius:6px;transition:all .15s}
.sb-footer a:hover{color:var(--green);background:rgba(0,255,65,0.03)}

/* Main */
.main{flex:1;display:flex;flex-direction:column;min-width:0;position:relative}
.topbar{height:48px;display:flex;align-items:center;justify-content:space-between;padding:0 20px;border-bottom:1px solid rgba(255,255,255,0.04);flex-shrink:0;backdrop-filter:blur(10px);background:rgba(5,5,5,0.8)}
.tb-left{display:flex;align-items:center;gap:8px}
.menu-btn{display:none;background:none;border:none;color:var(--text2);cursor:pointer;padding:4px}
.menu-btn svg{width:18px;height:18px}
.tb-title{font-size:13px;font-weight:500;color:var(--text)}
.tb-right{display:flex;align-items:center;gap:8px}
.tb-status{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--text3);font-family:'JetBrains Mono',monospace}
.tb-dot{width:6px;height:6px;border-radius:50%;background:var(--green);box-shadow:0 0 8px rgba(0,255,65,0.4)}
.tb-dot.off{background:#ef4444;box-shadow:0 0 8px rgba(239,68,68,0.4)}

/* Workspace bar */
.ws-bar{display:none;height:32px;align-items:center;gap:8px;padding:0 20px;border-bottom:1px solid rgba(255,255,255,0.04);flex-shrink:0;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text3);background:rgba(5,5,5,0.6);overflow:hidden}
.ws-bar.show{display:flex}
.ws-bar .ws-branch{display:inline-flex;align-items:center;gap:4px;color:var(--green);background:rgba(0,255,65,0.05);border:1px solid rgba(0,255,65,0.12);padding:2px 8px;border-radius:4px;font-size:10px;white-space:nowrap}
.ws-bar .ws-path{color:var(--text3);opacity:.6;font-size:10px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ws-bar .ws-stat{display:inline-flex;align-items:center;gap:3px;padding:2px 6px;border-radius:4px;font-size:10px;white-space:nowrap}
.ws-bar .ws-stat.changes{color:var(--accent);background:rgba(232,86,42,0.08);border:1px solid rgba(232,86,42,0.15)}
.ws-bar .ws-stat.clean{color:var(--text3);opacity:.5}
.ws-bar .ws-files{color:var(--text3);opacity:.5;font-size:10px;margin-left:auto;white-space:nowrap}
.ws-bar .ws-btn{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:4px;font-size:10px;color:var(--text2);background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);cursor:pointer;white-space:nowrap;transition:all .15s}
.ws-bar .ws-btn:hover{background:rgba(0,255,65,0.05);color:var(--green);border-color:rgba(0,255,65,0.2)}

/* Content */
.content-area{flex:1;display:flex;flex-direction:column;min-height:0}
.welcome{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 24px}
.welcome.hidden{display:none}
.w-icon{font-size:40px;margin-bottom:16px;opacity:.6}
.w-title{font-family:'Playfair Display',serif;font-size:24px;font-weight:500;margin-bottom:8px;letter-spacing:-.3px}
.w-sub{font-size:14px;color:var(--text3);font-weight:300}

/* Messages */
.messages{flex:1;overflow-y:auto;padding:20px 0;display:none}
.messages.show{display:block}
.messages::-webkit-scrollbar{width:4px}
.messages::-webkit-scrollbar-thumb{background:var(--dark4);border-radius:4px}
.msg-wrap{padding:10px 0}
.msg-wrap.assistant{background:transparent}
.msg-inner{max-width:700px;margin:0 auto;padding:0 24px;display:flex;gap:10px;align-items:flex-end}
.msg-wrap.user .msg-inner{flex-direction:row-reverse}
.msg-icon{width:26px;height:26px;border-radius:8px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:12px}
.msg-icon.u{background:var(--accent);color:#fff;font-weight:600;font-size:9px;letter-spacing:.5px}
.msg-icon.a{background:rgba(0,255,65,0.08);color:var(--green);font-size:14px;border:1px solid rgba(0,255,65,0.1)}
.msg-content{max-width:80%;min-width:0;font-size:14px;line-height:1.8;font-weight:400;color:var(--text)}
.msg-wrap.user .msg-content{background:rgba(232,86,42,0.12);border:1px solid rgba(232,86,42,0.18);padding:10px 16px;border-radius:18px 18px 4px 18px;text-align:left}
.msg-wrap.assistant .msg-content{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.05);padding:10px 16px;border-radius:18px 18px 18px 4px}
.msg-content p{margin-bottom:8px}.msg-content p:last-child{margin-bottom:0}
.msg-content strong{font-weight:600;color:var(--text)}
.msg-content code{font-family:'JetBrains Mono',monospace;font-size:12px;background:rgba(0,255,65,0.05);border:1px solid rgba(0,255,65,0.08);padding:1px 6px;border-radius:4px;color:var(--green)}
.msg-content pre{background:var(--dark);border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:16px;margin:12px 0;overflow-x:auto;font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.7}
.msg-content pre code{background:none;border:none;padding:0;color:var(--text)}
.msg-content h2.md-h,.msg-content h3.md-h,.msg-content h4.md-h{margin:14px 0 6px;color:var(--text);font-weight:600;line-height:1.4}
.msg-content h2.md-h{font-size:16px}.msg-content h3.md-h{font-size:14px}.msg-content h4.md-h{font-size:13px}
.msg-content ul.md-list,.msg-content ol.md-list{margin:6px 0;padding-left:20px;line-height:1.8;font-size:13px}
.msg-content .md-list li{margin:2px 0}.msg-content .md-list li::marker{color:var(--text3)}
.msg-content em{font-style:italic;color:var(--text2)}
.msg-content a.md-link{color:var(--green);text-decoration:none;border-bottom:1px solid rgba(0,255,65,0.2)}.msg-content a.md-link:hover{border-bottom-color:var(--green)}
.msg-time{font-size:10px;color:var(--text3);margin-top:6px;font-family:'JetBrains Mono',monospace}
.msg-wrap.user .msg-time{text-align:right}

/* Input */
.input-area{padding:12px 24px 20px;flex-shrink:0}
.input-box{max-width:700px;margin:0 auto;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:16px;overflow:hidden;transition:all .2s;backdrop-filter:blur(10px)}
.input-box:focus-within{border-color:rgba(0,255,65,0.2);box-shadow:0 0 0 3px rgba(0,255,65,0.03)}
.input-box textarea{width:100%;min-height:44px;max-height:200px;background:transparent;border:none;padding:14px 18px 8px;color:var(--text);font-size:14px;font-family:inherit;resize:none;outline:none;line-height:1.5}
.input-box textarea::placeholder{color:var(--text3)}
.input-toolbar{display:flex;align-items:center;justify-content:space-between;padding:4px 8px 8px}
.input-toolbar-left{display:flex;align-items:center;gap:2px}
.input-toolbar-right{display:flex;align-items:center;gap:6px}
.tb-btn{width:32px;height:32px;border-radius:8px;border:none;background:transparent;color:var(--text3);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.tb-btn:hover{background:rgba(255,255,255,0.04);color:var(--text2)}
.tb-btn svg{width:18px;height:18px}
.model-btn{display:flex;align-items:center;gap:4px;padding:4px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text3);cursor:pointer;font-size:11px;font-family:'JetBrains Mono',monospace;transition:all .15s}
.model-btn:hover{background:rgba(0,255,65,0.03);border-color:rgba(0,255,65,0.15);color:var(--green)}
.send-btn{width:34px;height:34px;border-radius:10px;border:none;background:var(--accent);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.send-btn:hover{background:var(--accent2);transform:translateY(-1px);box-shadow:0 4px 15px rgba(232,86,42,0.3)}
.send-btn:disabled{opacity:.3;cursor:not-allowed;transform:none;box-shadow:none}
.send-btn svg{width:16px;height:16px}

.file-preview{display:flex;gap:6px;padding:4px 12px;flex-wrap:wrap}
.file-tag{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:8px;font-size:11px;color:var(--text2)}
.file-tag .rm{cursor:pointer;opacity:.5;font-size:13px}.file-tag .rm:hover{opacity:1;color:#ef4444}

.typing-dots{display:inline-flex;gap:3px;padding:2px 0}
.typing-dots span{width:5px;height:5px;border-radius:50%;background:var(--green);animation:pulse 1.4s infinite both}
.typing-dots span:nth-child(2){animation-delay:.2s}
.typing-dots span:nth-child(3){animation-delay:.4s}
@keyframes pulse{0%,80%,100%{opacity:.2;transform:scale(.8)}40%{opacity:1;transform:scale(1)}}

/* Model Popup */
.model-popup{display:none;position:fixed;background:var(--dark);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:6px;min-width:240px;box-shadow:0 16px 48px rgba(0,0,0,0.6);z-index:99999;backdrop-filter:blur(20px)}
.model-popup.show{display:block}
.mp-section{padding:6px 12px 4px;font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:1.2px;font-family:'JetBrains Mono',monospace}
.mp-section:not(:first-child){border-top:1px solid rgba(255,255,255,0.04);margin-top:4px;padding-top:10px}
.mp-item{padding:8px 12px;border-radius:8px;font-size:13px;color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:space-between;transition:all .1s}
.mp-item:hover{background:rgba(0,255,65,0.03);color:var(--text)}
.mp-item.active{color:var(--green)}
.mp-item .ck{display:none;color:var(--green);font-size:12px}.mp-item.active .ck{display:inline}

.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:15}
.overlay.show{display:block}

/* Quick tips on welcome */
.quick-tips{display:flex;flex-wrap:wrap;gap:10px;margin-top:24px;max-width:520px;justify-content:center}
.tip-card{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:14px 18px;cursor:pointer;transition:all .2s;flex:1;min-width:140px;max-width:240px;text-align:left}
.tip-card:hover{border-color:rgba(0,255,65,0.2);background:rgba(0,255,65,0.02);transform:translateY(-2px)}
.tip-title{font-size:12px;font-weight:600;color:var(--text);margin-bottom:4px;display:flex;align-items:center;gap:6px}
.tip-desc{font-size:11px;color:var(--text3);line-height:1.5}

/* Help popup */
.help-btn-chat{display:inline-flex;align-items:center;gap:6px;font-size:11px;color:var(--text3);cursor:pointer;font-family:'JetBrains Mono',monospace;transition:color .2s;padding:4px 0}
.help-btn-chat:hover{color:var(--green)}
.help-btn-chat .qm{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;background:rgba(0,255,65,0.08);border:1px solid rgba(0,255,65,0.15);color:var(--green);font-size:9px;font-weight:700}

.help-popup-chat{display:none;position:fixed;z-index:200;width:360px;max-width:90vw;background:var(--dark);border:1px solid rgba(0,255,65,0.15);border-radius:16px;padding:24px;box-shadow:0 16px 48px rgba(0,0,0,0.6);backdrop-filter:blur(20px);top:50%;left:50%;transform:translate(-50%,-50%)}
.help-popup-chat.show{display:block}
.help-popup-chat h3{font-size:15px;font-weight:600;color:var(--text);margin-bottom:14px}
.help-popup-chat .close-help{position:absolute;top:12px;right:14px;background:none;border:none;color:var(--text3);cursor:pointer;font-size:18px}
.help-popup-chat .close-help:hover{color:var(--text)}
.help-popup-chat .help-item{padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.04);font-size:13px;color:var(--text2);line-height:1.7}
.help-popup-chat .help-item:last-child{border-bottom:none}
.help-popup-chat .help-item strong{color:var(--text);font-weight:500}
.help-popup-chat .help-item code{font-family:'JetBrains Mono',monospace;font-size:11px;background:rgba(0,255,65,0.05);border:1px solid rgba(0,255,65,0.08);padding:1px 5px;border-radius:4px;color:var(--green)}
.help-popup-chat a.help-ext{display:inline-flex;align-items:center;gap:4px;color:var(--green);text-decoration:none;font-size:12px;margin-top:10px;font-family:'JetBrains Mono',monospace}
.help-popup-chat a.help-ext:hover{text-decoration:underline}
.chat-help-overlay{display:none;position:fixed;inset:0;z-index:199;background:rgba(0,0,0,0.4)}
.chat-help-overlay.show{display:block}

/* Agent Progress â€” Claude Code style */
.agent-progress{margin:8px 0 10px;border-left:2px solid rgba(0,255,65,0.12);padding-left:12px}
.ap-step{display:flex;align-items:center;gap:6px;padding:2px 0;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text3);line-height:1.5}
.ap-step.active{color:var(--green)}
.ap-step .ap-mark{width:14px;flex-shrink:0;text-align:center;font-size:9px}
.ap-spin{display:inline-block;width:8px;height:8px;border:1.5px solid rgba(0,255,65,0.2);border-top-color:var(--green);border-radius:50%;animation:spin .6s linear infinite}
.ap-detail{opacity:.5;margin-left:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:220px}
.agent-progress.all-done{opacity:.5}
@keyframes spin{to{transform:rotate(360deg)}}

/* Orchestrator label */
.orch-label{font-size:10px;color:var(--text3);font-family:'JetBrains Mono',monospace;padding:4px 0 6px;display:flex;align-items:center;gap:4px;border-bottom:1px solid rgba(255,255,255,0.04);margin-bottom:6px}
.orch-reason{color:var(--text3);opacity:.6;font-size:9px}

/* Gateway status in topbar */
.tb-gw{font-size:10px;color:var(--text3);font-family:'JetBrains Mono',monospace;margin-left:12px;padding:3px 8px;border-radius:4px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.05)}
.tb-gw.on{color:var(--green);border-color:rgba(0,255,65,0.15);background:rgba(0,255,65,0.03)}

@media(max-width:768px){
.sidebar{position:fixed;left:0;top:0;bottom:0;transform:translateX(-100%)}
.sidebar.open{transform:translateX(0)}
.menu-btn{display:flex}
.msg-inner{padding:0 16px}
.input-area{padding:8px 12px 12px}
}
</style>
</head>
<body>
<div class="app">
<div class="overlay" id="overlay" onclick="toggleSB()"></div>
<div class="sidebar" id="sidebar">
<div class="sb-top"><a href="/" class="sb-logo">ğŸ¦ EasyClaw <span>chat</span></a><button class="sb-new" onclick="newChat()" title="æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆ">+</button></div>
<div class="sb-sessions" id="sessionList"></div>
<div class="sb-footer">
<a href="/setup.html"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>è¨­å®š</a>
<a onclick="showChatHelp()" style="cursor:pointer"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>ãƒ˜ãƒ«ãƒ—</a>
<a onclick="doLogout()" style="cursor:pointer"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"/></svg>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
<a onclick="setLang(LANG==='ja'?'en':'ja')" style="cursor:pointer"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg><span id="langBtn">EN</span></a>
</div>
</div>
<div class="main">
<div class="topbar">
<div class="tb-left">
<button class="menu-btn" onclick="toggleSB()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="15" y2="12"/><line x1="3" y1="18" x2="18" y2="18"/></svg></button>
<span class="tb-title" id="topTitle">æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆ</span>
</div>
<div class="tb-right"><div class="tb-status"><span class="tb-dot" id="statusDot"></span><span id="statusText">æ¥ç¶šä¸­</span></div><span class="tb-gw" id="gwBadge">GW: ---</span></div>
</div>
<div class="ws-bar" id="wsBar"></div>
<div class="content-area">
<div class="welcome" id="welcome">
<div class="w-icon">ğŸ¦</div>
<div class="w-title" id="greeting"></div>
<div class="w-sub">ä½•ã§ã‚‚èã„ã¦ãã ã•ã„</div>
<div class="quick-tips">
  <div class="tip-card" onclick="insertPrompt('ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã«git initã—ã¦ã€README.mdã‚’ä½œæˆã—ã¦')">
    <div class="tip-title">ğŸ™ GitHub</div>
    <div class="tip-desc">GitåˆæœŸåŒ–ãƒ»ãƒªãƒã‚¸ãƒˆãƒªç®¡ç†</div>
  </div>
  <div class="tip-card" onclick="insertPrompt('Pythonã§ç°¡å˜ãªWebã‚¹ã‚¯ãƒ¬ã‚¤ãƒ‘ãƒ¼ã‚’ä½œã£ã¦')">
    <div class="tip-title">ğŸ’» ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ</div>
    <div class="tip-desc">ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚’æ‰‹ä¼ã£ã¦ã‚‚ã‚‰ã†</div>
  </div>
  <div class="tip-card" onclick="insertPrompt('https://example.com ã‚’é–‹ã„ã¦å†…å®¹ã‚’æ•™ãˆã¦')">
    <div class="tip-title">ğŸ–¥ï¸ ãƒ–ãƒ©ã‚¦ã‚¶</div>
    <div class="tip-desc">AIãŒã‚¦ã‚§ãƒ–ã‚’é–²è¦§ã—ã¦æƒ…å ±ã‚’å–å¾—</div>
  </div>
  <div class="tip-card" id="gitTipCard" style="display:none" onclick="insertPrompt('å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦ã€ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦')">
    <div class="tip-title">ğŸ”€ Gitæ“ä½œ</div>
    <div class="tip-desc">ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥ãƒ»PRä½œæˆ</div>
  </div>
</div>
</div>
<div class="messages" id="messages"></div>
</div>
<div class="input-area">
<div class="input-box">
<div class="file-preview" id="filePreview"></div>
<textarea id="chatInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." rows="1" onkeydown="hk(event)" oninput="ar(this)"></textarea>
<div class="input-toolbar">
<div class="input-toolbar-left">
<button class="tb-btn" onclick="triggerFile()" title="ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg></button>
</div>
<div class="input-toolbar-right">
<button class="model-btn" id="modelBtn" onclick="toggleModel()"><span id="modelLabel">...</span> <span style="font-size:10px">â–¾</span></button>
<button class="send-btn" id="sendBtn" onclick="send()"><svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="model-popup" id="modelPopup"></div>
<input type="file" id="fileInput" style="display:none" multiple accept="image/*,.pdf,.txt,.csv,.json,.md" onchange="handleFiles(this)">

<div class="chat-help-overlay" id="chatHelpOverlay" onclick="closeChatHelp()"></div>
<div class="help-popup-chat" id="chatHelpPopup">
  <button class="close-help" onclick="closeChatHelp()">&times;</button>
  <h3>ğŸ’¡ ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</h3>
  <div class="help-item"><strong>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡</strong> â€” å…¥åŠ›æ¬„ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’æ‰“ã£ã¦ Enter ã‚­ãƒ¼ã§é€ä¿¡ã€‚Shift+Enter ã§æ”¹è¡Œã€‚</div>
  <div class="help-item"><strong>ãƒ¢ãƒ‡ãƒ«åˆ‡ã‚Šæ›¿ãˆ</strong> â€” å…¥åŠ›æ¬„ã®å³ä¸‹ã«ã‚ã‚‹ãƒ¢ãƒ‡ãƒ«åã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€åˆ¥ã®AIãƒ¢ãƒ‡ãƒ«ã«åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚</div>
  <div class="help-item"><strong>æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆ</strong> â€” ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã€Œ+ã€ãƒœã‚¿ãƒ³ã§æ–°ã—ã„ä¼šè©±ã‚’é–‹å§‹ã§ãã¾ã™ã€‚</div>
  <div class="help-item"><strong>ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ©Ÿèƒ½</strong> â€” OpenClaw GatewayãŒèµ·å‹•ä¸­ï¼ˆå³ä¸Šã®ã€ŒGW: ONã€ï¼‰ãªã‚‰ã€AIã¯ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—ã‚„ã‚¿ã‚¹ã‚¯å®Ÿè¡ŒãŒå¯èƒ½ã§ã™ã€‚å‡¦ç†ä¸­ã¯ãƒãƒ£ãƒƒãƒˆå†…ã«ãƒ„ãƒ¼ãƒ«ã®å®Ÿè¡ŒçŠ¶æ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
  <div class="help-item"><strong>AIãŒåå¿œã—ãªã„å ´åˆ</strong> â€” å³ä¸Šã®ã€ŒOllamaã€ãŒã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãªã‚‰ <code>ollama serve</code> ã‚’å®Ÿè¡Œã€‚ã€ŒGW: OFFã€ãªã‚‰ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ã‹ã‚‰Gatewayã‚’èµ·å‹•ã—ã¦ãã ã•ã„ã€‚</div>
  <div class="help-item"><strong>è¨­å®šå¤‰æ›´</strong> â€” ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã€Œè¨­å®šã€ã‹ã‚‰ãƒ¢ãƒ‡ãƒ«ã‚„Gatewayã®è¨­å®šã‚’å¤‰æ›´ã§ãã¾ã™ã€‚</div>
  <a class="help-ext" href="https://ollama.com/library" target="_blank">â†— åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ«ä¸€è¦§</a>
</div>
<script>
var T = localStorage.getItem("token");
if (!T) location.href = "/app.html";

// --- i18n (æ—¥æœ¬èª/English) ---
var LANG = localStorage.getItem("easyclaw-lang") || "ja";
var I18N = {
  ja: {
    newChat: "æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆ", inputPlaceholder: "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...",
    settings: "è¨­å®š", help: "ãƒ˜ãƒ«ãƒ—", logout: "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ", attach: "ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜",
    greeting_morning: "ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™", greeting_afternoon: "ã“ã‚“ã«ã¡ã¯", greeting_evening: "ã“ã‚“ã°ã‚“ã¯",
    welcome_sub: "ä½•ã§ã‚‚èã„ã¦ãã ã•ã„",
    tip_github: "GitHub", tip_github_desc: "GitåˆæœŸåŒ–ãƒ»ãƒªãƒã‚¸ãƒˆãƒªç®¡ç†",
    tip_code: "ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ", tip_code_desc: "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚’æ‰‹ä¼ã£ã¦ã‚‚ã‚‰ã†",
    tip_browser: "ãƒ–ãƒ©ã‚¦ã‚¶", tip_browser_desc: "AIãŒã‚¦ã‚§ãƒ–ã‚’é–²è¦§ã—ã¦æƒ…å ±ã‚’å–å¾—",
    tip_git: "Gitæ“ä½œ", tip_git_desc: "ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥ãƒ»PRä½œæˆ",
    connecting: "æ¥ç¶šä¸­", connected: "Ollamaæ¥ç¶šä¸­", offline: "ã‚ªãƒ•ãƒ©ã‚¤ãƒ³",
    today: "ä»Šæ—¥", yesterday: "æ˜¨æ—¥", thisWeek: "ä»Šé€±", older: "ãã‚Œä»¥å‰",
    changes: "å¤‰æ›´", clean: "ã‚¯ãƒªãƒ¼ãƒ³", files: "ãƒ•ã‚¡ã‚¤ãƒ«",
    stepsCompleted: "ã‚¹ãƒ†ãƒƒãƒ—å®Œäº†",
    help_title: "ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰",
    help_send: "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡", help_send_desc: "å…¥åŠ›æ¬„ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’æ‰“ã£ã¦ Enter ã‚­ãƒ¼ã§é€ä¿¡ã€‚Shift+Enter ã§æ”¹è¡Œã€‚",
    help_model: "ãƒ¢ãƒ‡ãƒ«åˆ‡ã‚Šæ›¿ãˆ", help_model_desc: "å…¥åŠ›æ¬„ã®å³ä¸‹ã«ã‚ã‚‹ãƒ¢ãƒ‡ãƒ«åã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€åˆ¥ã®AIãƒ¢ãƒ‡ãƒ«ã«åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚",
    help_new: "æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆ", help_new_desc: "ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã€Œ+ã€ãƒœã‚¿ãƒ³ã§æ–°ã—ã„ä¼šè©±ã‚’é–‹å§‹ã§ãã¾ã™ã€‚",
    help_agent: "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ©Ÿèƒ½", help_agent_desc: "OpenClaw GatewayãŒèµ·å‹•ä¸­ãªã‚‰ã€AIã¯ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—ã‚„ã‚¿ã‚¹ã‚¯å®Ÿè¡ŒãŒå¯èƒ½ã§ã™ã€‚",
    help_offline: "AIãŒåå¿œã—ãªã„å ´åˆ", help_offline_desc: "å³ä¸Šã®ã€ŒOllamaã€ãŒã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãªã‚‰ ollama serve ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚",
    help_settings: "è¨­å®šå¤‰æ›´", help_settings_desc: "ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã€Œè¨­å®šã€ã‹ã‚‰ãƒ¢ãƒ‡ãƒ«ã‚„Gatewayã®è¨­å®šã‚’å¤‰æ›´ã§ãã¾ã™ã€‚",
    act_planning: "ã‚¿ã‚¹ã‚¯åˆ†æ", act_thinking: "åˆ¤æ–­ä¸­", act_file_write: "ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿",
    act_file_edit: "ãƒ•ã‚¡ã‚¤ãƒ«ç·¨é›†", act_file_read: "ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿å–ã‚Š", act_list_files: "ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§",
    act_grep: "ã‚³ãƒ¼ãƒ‰æ¤œç´¢", act_shell: "ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ", act_search: "æ¤œç´¢",
    orch_chat: "é«˜é€Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹", orch_coding: "ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ", orch_reasoning: "æ·±ã„æ¨è«–",
    orch_browser: "ãƒ–ãƒ©ã‚¦ã‚¶ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ", orch_manual: "æ‰‹å‹•é¸æŠ",
    lang_toggle: "EN"
  },
  en: {
    newChat: "New Chat", inputPlaceholder: "Type a message...",
    settings: "Settings", help: "Help", logout: "Logout", attach: "Attach file",
    greeting_morning: "Good morning", greeting_afternoon: "Hello", greeting_evening: "Good evening",
    welcome_sub: "Ask me anything",
    tip_github: "GitHub", tip_github_desc: "Initialize Git & manage repos",
    tip_code: "Code", tip_code_desc: "Get help with programming",
    tip_browser: "Browser", tip_browser_desc: "AI browses the web for you",
    tip_git: "Git", tip_git_desc: "Commit, push & create PRs",
    connecting: "Connecting", connected: "Ollama connected", offline: "Offline",
    today: "Today", yesterday: "Yesterday", thisWeek: "This week", older: "Older",
    changes: "changes", clean: "clean", files: "files",
    stepsCompleted: "steps completed",
    help_title: "Usage Guide",
    help_send: "Send message", help_send_desc: "Type in the input box and press Enter to send. Shift+Enter for newline.",
    help_model: "Switch model", help_model_desc: "Click the model name at the bottom right to switch AI models.",
    help_new: "New chat", help_new_desc: "Click the \"+\" button in the sidebar to start a new conversation.",
    help_agent: "Agent mode", help_agent_desc: "When OpenClaw Gateway is running, AI can call tools and execute tasks.",
    help_offline: "AI not responding", help_offline_desc: "If Ollama is offline, run 'ollama serve'. If GW is OFF, start Gateway from setup.",
    help_settings: "Settings", help_settings_desc: "Change model and Gateway settings from sidebar Settings.",
    act_planning: "Planning", act_thinking: "Thinking", act_file_write: "Writing file",
    act_file_edit: "Editing file", act_file_read: "Reading file", act_list_files: "Listing files",
    act_grep: "Searching code", act_shell: "Running command", act_search: "Searching",
    orch_chat: "Fast response", orch_coding: "Coding agent", orch_reasoning: "Deep reasoning",
    orch_browser: "Browser agent", orch_manual: "Manual",
    lang_toggle: "JP"
  }
};
function t(key) { return (I18N[LANG] || I18N.ja)[key] || key; }
function setLang(lang) {
  LANG = lang; localStorage.setItem("easyclaw-lang", lang);
  // Update static elements
  document.getElementById("chatInput").placeholder = t("inputPlaceholder");
  document.getElementById("topTitle").textContent = curSession ? document.getElementById("topTitle").textContent : t("newChat");
  document.querySelector(".w-sub").textContent = t("welcome_sub");
  document.getElementById("langBtn").textContent = t("lang_toggle");
  // Sidebar footer
  var footerLinks = document.querySelectorAll(".sb-footer a");
  if (footerLinks[0]) footerLinks[0].lastChild.textContent = t("settings");
  if (footerLinks[1]) footerLinks[1].lastChild.textContent = t("help");
  if (footerLinks[2]) footerLinks[2].lastChild.textContent = t("logout");
  // Tip cards
  var tips = document.querySelectorAll(".tip-title");
  var descs = document.querySelectorAll(".tip-desc");
  if (tips[0]) { tips[0].textContent = "ğŸ™ " + t("tip_github"); descs[0].textContent = t("tip_github_desc"); }
  if (tips[1]) { tips[1].textContent = "ğŸ’» " + t("tip_code"); descs[1].textContent = t("tip_code_desc"); }
  if (tips[2]) { tips[2].textContent = "ğŸ–¥ï¸ " + t("tip_browser"); descs[2].textContent = t("tip_browser_desc"); }
  if (tips[3]) { tips[3].textContent = "ğŸ”€ " + t("tip_git"); descs[3].textContent = t("tip_git_desc"); }
  // Help popup
  var helpTitle = document.querySelector(".help-popup-chat h3");
  if (helpTitle) helpTitle.textContent = "ğŸ’¡ " + t("help_title");
  setGreeting();
  // Reload sessions to update date labels
  loadSessions();
}

var curSession = null, sessions = [], busy = false, attachedFiles = [], currentModel = "", userSettings = null, gatewayOnline = false, currentActivities = [];

function api(u, o) { o = o || {}; o.headers = Object.assign({ "Authorization": "Bearer " + T, "Content-Type": "application/json" }, o.headers || {}); return fetch(u, o).then(function(r) { return r.json() }) }

async function init() {
  setGreeting();
  // Apply saved language
  document.getElementById("chatInput").placeholder = t("inputPlaceholder");
  document.getElementById("langBtn").textContent = t("lang_toggle");
  document.querySelector(".w-sub").textContent = t("welcome_sub");
  await loadSettings();
  await checkHealth();
  await loadSessions();
  await loadWorkspaceStatus();
  document.getElementById("chatInput").focus();
}

async function loadWorkspaceStatus() {
  try {
    var ws = await api("/api/workspace/status");
    var bar = document.getElementById("wsBar");
    var html = "";
    if (ws.git) {
      html += '<span class="ws-branch">â‡ ' + esc(ws.git.branch || "main") + '</span>';
      if (ws.git.changed > 0) {
        html += '<span class="ws-stat changes">' + ws.git.changed + ' ' + t("changes") + '</span>';
      } else {
        html += '<span class="ws-stat clean">âœ“ ' + t("clean") + '</span>';
      }
      if (ws.git.ahead > 0) html += '<span class="ws-stat" style="color:var(--green)">â†‘' + ws.git.ahead + '</span>';
      if (ws.git.behind > 0) html += '<span class="ws-stat" style="color:var(--accent)">â†“' + ws.git.behind + '</span>';
      if (ws.git.remote) {
        var repoName = ws.git.remote.replace(/.*[\/:]([^\/]+\/[^\/]+?)(?:\.git)?$/, "$1");
        html += '<span class="ws-btn" onclick="insertPrompt(\'ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã®çŠ¶æ…‹ã‚’æ•™ãˆã¦\')" title="' + esc(ws.git.remote) + '">ğŸ™ ' + esc(repoName) + '</span>';
      }
      // Show git tip card
      var gitTip = document.getElementById("gitTipCard");
      if (gitTip) gitTip.style.display = "";
    } else {
      html += '<span class="ws-path">ğŸ“ ~/easyclaw-workspace</span>';
      html += '<span class="ws-stat clean">' + (ws.files || 0) + ' ' + t("files") + '</span>';
      html += '<span class="ws-btn" onclick="insertPrompt(\'ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã«git initã—ã¦\')" title="GitåˆæœŸåŒ–">âŠ• git init</span>';
    }
    bar.innerHTML = html;
    bar.classList.add("show");
  } catch(e) { /* ignore */ }
}

function setGreeting() { var h = new Date().getHours(); document.getElementById("greeting").textContent = h < 5 ? t("greeting_evening") : h < 12 ? t("greeting_morning") : h < 18 ? t("greeting_afternoon") : t("greeting_evening") }

async function loadSettings() {
  try {
    var d = await api("/api/settings");
    userSettings = d.settings;
    currentModel = "auto";
    document.getElementById("modelLabel").textContent = "ğŸ¤– auto";
    buildModelPopup();
  } catch(e) {
    currentModel = "auto";
    document.getElementById("modelLabel").textContent = "ğŸ¤– auto";
  }
}

async function buildModelPopup() {
  var popup = document.getElementById("modelPopup");
  var html = "";

  // Auto-orchestration option
  html += '<div class="mp-section">Orchestrator</div>';
  var autoActive = currentModel === "auto" ? " active" : "";
  html += '<div class="mp-item' + autoActive + '" onclick="setModel(\'auto\',this)">ğŸ¤– auto <span style="font-size:10px;color:var(--text3);margin-left:4px">ã‚¿ã‚¹ã‚¯ã«å¿œã˜ã¦è‡ªå‹•é¸æŠ</span><span class="ck">âœ“</span></div>';

  if (!userSettings || userSettings.provider === "ollama") {
    html += '<div class="mp-section">Ollama (Local)</div>';
    try {
      var d = await api("/api/ollama/models");
      if (d.success && d.models.length > 0) {
        d.models.forEach(function(m) {
          var active = m.name === currentModel ? " active" : "";
          html += '<div class="mp-item' + active + '" onclick="setModel(\'' + m.name + '\',this)">' + m.name + '<span class="ck">âœ“</span></div>';
        });
      } else {
        html += '<div class="mp-item" style="color:var(--text3);cursor:default">ãƒ¢ãƒ‡ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
      }
    } catch(e) {
      html += '<div class="mp-item" style="color:var(--text3);cursor:default">Ollamaæœªæ¥ç¶š</div>';
    }
  } else {
    var models = {
      google: [["google/gemini-2.5-flash","Gemini 2.5 Flash"],["google/gemini-2.5-pro","Gemini 2.5 Pro"]],
      anthropic: [["anthropic/claude-sonnet-4-5-20250929","Claude Sonnet 4.5"],["anthropic/claude-haiku-4-5-20251001","Claude Haiku 4.5"]],
      openai: [["openai/gpt-4o","GPT-4o"],["openai/gpt-4o-mini","GPT-4o Mini"]]
    };
    var provider = userSettings.provider;
    var names = { google: "Google", anthropic: "Anthropic", openai: "OpenAI" };
    html += '<div class="mp-section">' + (names[provider] || provider) + '</div>';
    (models[provider] || []).forEach(function(m) {
      var active = m[0] === currentModel ? " active" : "";
      html += '<div class="mp-item' + active + '" onclick="setModel(\'' + m[0] + '\',this)">' + m[1] + '<span class="ck">âœ“</span></div>';
    });
  }
  popup.innerHTML = html;
}

async function checkHealth() {
  // Check Ollama
  try {
    if (!userSettings || userSettings.provider === "ollama") {
      var h = await api("/api/ollama/health");
      if (h.ok) { document.getElementById("statusDot").className = "tb-dot"; document.getElementById("statusText").textContent = "Ollamaæ¥ç¶šä¸­"; }
      else throw 0;
    } else {
      document.getElementById("statusDot").className = "tb-dot";
      document.getElementById("statusText").textContent = "APIæ¥ç¶šä¸­";
    }
  } catch(e) { document.getElementById("statusDot").className = "tb-dot off"; document.getElementById("statusText").textContent = "ã‚ªãƒ•ãƒ©ã‚¤ãƒ³"; }

  // Check Gateway
  try {
    var gw = await fetch("/api/openclaw/status").then(function(r){ return r.json() });
    gatewayOnline = gw.running && gw.connected;
    var badge = document.getElementById("gwBadge");
    if (gatewayOnline) { badge.textContent = "GW: ON"; badge.className = "tb-gw on"; }
    else if (gw.running) { badge.textContent = "GW: èµ·å‹•ä¸­"; badge.className = "tb-gw"; }
    else { badge.textContent = "GW: OFF"; badge.className = "tb-gw"; }
  } catch(e) {
    document.getElementById("gwBadge").textContent = "GW: ---";
    document.getElementById("gwBadge").className = "tb-gw";
  }
}

async function loadSessions() {
  try {
    var d = await api("/api/local/chat/sessions");
    sessions = d.sessions || [];
    renderSB();
  } catch(e) {}
}

function renderSB() {
  var el = document.getElementById("sessionList");
  if (!sessions.length) { el.innerHTML = '<div style="padding:24px 12px;text-align:center;color:var(--text3);font-size:12px;font-family:JetBrains Mono,monospace">No chats yet</div>'; return }
  var now = Date.now(), html = "", prev = "";
  sessions.forEach(function(s) {
    var ts = new Date(s.updatedAt || s.createdAt).getTime();
    var diff = now - ts;
    var lb = diff < 86400000 ? t("today") : diff < 172800000 ? t("yesterday") : diff < 604800000 ? t("thisWeek") : t("older");
    if (lb !== prev) { html += '<div class="sb-label">' + lb + '</div>'; prev = lb }
    var ac = s.sessionKey === curSession ? " active" : "";
    html += '<div class="sb-item' + ac + '" onclick="openSession(\'' + esc(s.sessionKey) + '\')">' + esc(s.title || "ãƒãƒ£ãƒƒãƒˆ") + '</div>';
  });
  el.innerHTML = html;
}

function openSession(k) { curSession = k; renderSB(); showChat(); loadHistory(k); closeSB() }

async function loadHistory(k) {
  var m = document.getElementById("messages");
  m.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text3);font-family:JetBrains Mono,monospace;font-size:12px">loading...</div>';
  try {
    var d = await api("/api/local/chat/history?sessionKey=" + encodeURIComponent(k));
    var msgs = d.messages || [];
    if (msgs.length > 0) {
      var title = msgs.find(function(x){ return x.role === "user" });
      if (title) {
        var t = title.content.slice(0, 30) + (title.content.length > 30 ? "..." : "");
        document.getElementById("topTitle").textContent = t;
      }
    }
    m.innerHTML = msgs.map(renderMsg).join("");
    m.scrollTop = m.scrollHeight;
  } catch(e) { m.innerHTML = '<div style="padding:40px;text-align:center;color:#ef4444;font-size:13px">èª­ã¿è¾¼ã¿å¤±æ•—</div>' }
}

function renderMsg(msg) {
  if (msg.role === "system") return "";
  var isU = msg.role === "user";
  var cls = isU ? "user" : "assistant";
  var icon = isU ? '<div class="msg-icon u">You</div>' : '<div class="msg-icon a">ğŸ¦</div>';
  var body = fmt(msg.content || "");
  if (!body) return "";
  var t = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString("ja-JP", { hour: "2-digit", minute: "2-digit" }) : "";
  return '<div class="msg-wrap ' + cls + '"><div class="msg-inner">' + icon + '<div class="msg-content"><div>' + body + '</div>' + (t ? '<div class="msg-time">' + t + '</div>' : '') + '</div></div></div>';
}

async function send() {
  var inp = document.getElementById("chatInput");
  var txt = inp.value.trim();
  if (!txt || busy) return;
  busy = true;
  currentActivities = [];
  document.getElementById("sendBtn").disabled = true;
  inp.value = ""; ar(inp);

  if (!curSession) { curSession = null; showChat(); }

  var m = document.getElementById("messages");
  m.innerHTML += renderMsg({ role: "user", content: txt, timestamp: new Date().toISOString() });
  // Add typing indicator
  m.innerHTML += '<div class="msg-wrap assistant" id="typing"><div class="msg-inner"><div class="msg-icon a">ğŸ¦</div><div class="msg-content"><div class="typing-dots"><span></span><span></span><span></span></div></div></div></div>';
  m.scrollTop = m.scrollHeight;

  try {
    var res = await fetch("/api/local/chat/send", {
      method: "POST",
      headers: { "Authorization": "Bearer " + T, "Content-Type": "application/json" },
      body: JSON.stringify({ message: txt, sessionKey: curSession, model: currentModel })
    });

    var reader = res.body.getReader();
    var decoder = new TextDecoder();
    var fullText = "";
    var typing = document.getElementById("typing");

    while (true) {
      var result = await reader.read();
      if (result.done) break;
      var chunk = decoder.decode(result.value, { stream: true });
      var lines = chunk.split("\n");

      for (var i = 0; i < lines.length; i++) {
        var line = lines[i].trim();
        if (!line.startsWith("data: ")) continue;
        var jsonStr = line.slice(6);
        if (jsonStr === "[DONE]") continue;
        try {
          var data = JSON.parse(jsonStr);
          // Capture sessionKey and orchestrator info from first message
          if (data.sessionKey && !curSession) {
            curSession = data.sessionKey;
          } else if (data.sessionKey && curSession === null) {
            curSession = data.sessionKey;
          }
          // Show orchestrator model selection
          if (data.orchestrator && typing) {
            var catIcons = { agent: "ğŸ¤–", coding: "ğŸ’»", reasoning: "ğŸ§ ", chat: "ğŸ’¬", manual: "ğŸ¯", browser: "ğŸ–¥ï¸" };
            var orchIcon = catIcons[data.orchestrator.category] || "ğŸ¤–";
            var reasonMap = { "é«˜é€Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹": t("orch_chat"), "ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ": t("orch_coding"), "æ·±ã„æ¨è«–": t("orch_reasoning"), "ãƒ–ãƒ©ã‚¦ã‚¶ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ": t("orch_browser"), "æ‰‹å‹•é¸æŠ": t("orch_manual") };
            var reason = reasonMap[data.orchestrator.reason] || data.orchestrator.reason;
            var orchLabel = '<div class="orch-label">' + orchIcon + ' ' + esc(data.orchestrator.model) + ' <span class="orch-reason">' + esc(reason) + '</span></div>';
            typing.querySelector(".msg-content").insertAdjacentHTML("afterbegin", orchLabel);
          }
          // Agent activity event â€” Claude Code style progress
          if (data.type === "agent_activity") {
            if (typing && data.status !== "done") {
              currentActivities.push(parseActivityInfo(data));
              var orchEl = typing.querySelector(".orch-label");
              var orchHtml = orchEl ? orchEl.outerHTML : "";
              var progressHtml = renderProgressPanel(currentActivities, false);
              var textHtml = fullText ? '<div>' + fmt(fullText) + '</div>' : '<div class="typing-dots"><span></span><span></span><span></span></div>';
              typing.querySelector(".msg-content").innerHTML = orchHtml + progressHtml + textHtml;
              m.scrollTop = m.scrollHeight;
            }
          }
          if (data.content) {
            fullText += data.content;
            if (typing) {
              var orchEl = typing.querySelector(".orch-label");
              var orchHtml = orchEl ? orchEl.outerHTML : "";
              var progressHtml = renderProgressPanel(currentActivities, true);
              typing.querySelector(".msg-content").innerHTML = orchHtml + progressHtml + '<div>' + fmt(fullText) + '</div>';
              m.scrollTop = m.scrollHeight;
            }
          }
          if (data.done) {
            if (typing) {
              // Final render with all activities marked done
              var orchEl = typing.querySelector(".orch-label");
              var orchHtml = orchEl ? orchEl.outerHTML : "";
              var progressHtml = renderProgressPanel(currentActivities, true);
              var textHtml = fullText ? '<div>' + fmt(fullText) + '</div>' : '';
              typing.querySelector(".msg-content").innerHTML = orchHtml + progressHtml + textHtml;
              typing.id = "";
            }
            currentActivities = [];
            if (txt) {
              var tt = txt.slice(0, 30) + (txt.length > 30 ? "..." : "");
              document.getElementById("topTitle").textContent = tt;
            }
            // Auto-refresh workspace bar after agent operations
            loadWorkspaceStatus();
          }
          if (data.error) {
            if (typing) {
              typing.querySelector(".msg-content").innerHTML = '<div style="color:#ef4444">' + esc(data.error) + '</div>';
              typing.id = "";
            }
          }
        } catch(e) {}
      }
    }
  } catch(e) {
    var typing = document.getElementById("typing");
    if (typing) { typing.querySelector(".msg-content").innerHTML = '<div style="color:#ef4444">é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + esc(e.message) + '</div>'; typing.id = ""; }
  }

  busy = false;
  document.getElementById("sendBtn").disabled = false;
  attachedFiles = [];
  document.getElementById("filePreview").innerHTML = "";
  loadSessions(); // Refresh sidebar
}

function showChat() { document.getElementById("welcome").classList.add("hidden"); var m = document.getElementById("messages"); m.classList.add("show"); document.getElementById("chatInput").focus() }
function clearMessages() { document.getElementById("messages").innerHTML = "" }
function showWelcome() { document.getElementById("welcome").classList.remove("hidden"); document.getElementById("messages").classList.remove("show"); document.getElementById("messages").innerHTML = ""; document.getElementById("topTitle").textContent = t("newChat") }
function newChat() { curSession = null; renderSB(); showWelcome(); closeSB(); document.getElementById("chatInput").focus() }

function hk(e) { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); send() } }
function ar(el) { el.style.height = "auto"; el.style.height = Math.min(el.scrollHeight, 200) + "px" }
function toggleSB() { document.getElementById("sidebar").classList.toggle("open"); document.getElementById("overlay").classList.toggle("show") }
function closeSB() { document.getElementById("sidebar").classList.remove("open"); document.getElementById("overlay").classList.remove("show") }
function esc(s) { var d = document.createElement("div"); d.textContent = s; return d.innerHTML }
function fmt(t) {
  var h = esc(t);
  // 1. Extract code blocks (preserve from further processing)
  var codeBlocks = [];
  h = h.replace(/```(\w*)\n([\s\S]*?)```/g, function(m, lang, code) {
    codeBlocks.push('<pre><code>' + code + '</code></pre>');
    return '\n%%CB' + (codeBlocks.length - 1) + '%%\n';
  });
  // 2. Headers
  h = h.replace(/^### (.+)$/gm, '<h4 class="md-h">$1</h4>');
  h = h.replace(/^## (.+)$/gm, '<h3 class="md-h">$1</h3>');
  h = h.replace(/^# (.+)$/gm, '<h2 class="md-h">$1</h2>');
  // 3. Unordered lists (group consecutive - or * lines)
  h = h.replace(/((?:^[-*] .+\n?)+)/gm, function(block) {
    var items = block.trim().split('\n').map(function(l) { return '<li>' + l.replace(/^[-*] /, '') + '</li>'; });
    return '<ul class="md-list">' + items.join('') + '</ul>\n';
  });
  // 4. Ordered lists
  h = h.replace(/((?:^\d+\. .+\n?)+)/gm, function(block) {
    var items = block.trim().split('\n').map(function(l) { return '<li>' + l.replace(/^\d+\. /, '') + '</li>'; });
    return '<ol class="md-list">' + items.join('') + '</ol>\n';
  });
  // 5. Inline code
  h = h.replace(/`([^`]+)`/g, '<code>$1</code>');
  // 6. Bold, italic
  h = h.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
  h = h.replace(/(?:^|\s)\*([^*]+)\*(?:\s|$)/g, ' <em>$1</em> ');
  // 7. Links
  h = h.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a class="md-link" href="$2" target="_blank">$1</a>');
  // 8. Line breaks (but not inside block elements)
  h = h.replace(/\n/g, '<br>');
  // 9. Clean up extra <br> around block elements
  h = h.replace(/<br>\s*(<(?:ul|ol|h[234]|pre))/g, '$1');
  h = h.replace(/(<\/(?:ul|ol|h[234]|pre)>)\s*<br>/g, '$1');
  // 10. Restore code blocks
  codeBlocks.forEach(function(block, i) { h = h.replace('%%CB' + i + '%%', block); });
  return h;
}
function triggerFile() { document.getElementById("fileInput").click() }
function handleFiles(input) { for (var i = 0; i < input.files.length; i++) attachedFiles.push(input.files[i]); renderFP(); input.value = "" }
function renderFP() { document.getElementById("filePreview").innerHTML = attachedFiles.map(function(f, i) { return '<div class="file-tag">ğŸ“ ' + esc(f.name) + ' <span class="rm" onclick="rmFile(' + i + ')">Ã—</span></div>' }).join("") }
function rmFile(i) { attachedFiles.splice(i, 1); renderFP() }
function toggleModel() { var mp = document.getElementById("modelPopup"); var btn = document.getElementById("modelBtn"); var r = btn.getBoundingClientRect(); mp.style.bottom = (window.innerHeight - r.top + 8) + "px"; mp.style.right = (window.innerWidth - r.right) + "px"; mp.classList.toggle("show") }
function setModel(id, el) { currentModel = id; document.getElementById("modelLabel").textContent = id === "auto" ? "ğŸ¤– auto" : id; document.querySelectorAll(".mp-item").forEach(function(e) { e.classList.remove("active") }); el.classList.add("active"); document.getElementById("modelPopup").classList.remove("show") }
function doLogout() { localStorage.removeItem("token"); localStorage.removeItem("email"); location.href = "/app.html" }
function insertPrompt(text) { var inp = document.getElementById("chatInput"); inp.value = text; inp.focus(); ar(inp) }
function parseActivityInfo(data) {
  var tool = data.tool || "tool";
  var label = "å‡¦ç†ä¸­";
  if (tool === "browser" && data.params && data.params.action) {
    var ba = { snapshot: "ãƒšãƒ¼ã‚¸è§£æ", thinking: "åˆ¤æ–­ä¸­", navigate: "ãƒšãƒ¼ã‚¸ç§»å‹•", click: "ã‚¯ãƒªãƒƒã‚¯", type: "ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›", scroll: "ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«", wait: "å¾…æ©Ÿä¸­" };
    label = ba[data.params.action] || data.params.action;
    if (data.params.action.includes("ãƒ–ãƒ©ã‚¦ã‚¶")) label = data.params.action;
  } else if (tool === "agent" && data.params && data.params.action) {
    var ca = { planning: t("act_planning"), thinking: t("act_thinking"), file_write: t("act_file_write"), file_edit: t("act_file_edit"), file_read: t("act_file_read"), list_files: t("act_list_files"), grep: t("act_grep"), shell: t("act_shell"), search: t("act_search") };
    label = ca[data.params.action] || data.params.action;
  } else {
    var tl = { web_fetch: "ã‚¦ã‚§ãƒ–å–å¾—", shell: "ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ", read_file: "ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿å–ã‚Š", browser: "ãƒ–ãƒ©ã‚¦ã‚¶æ“ä½œ", search: "æ¤œç´¢", agent: "ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ" };
    label = tl[tool] || tool;
  }
  var detail = (data.params && data.params.detail) ? data.params.detail : "";
  return { label: label, detail: detail };
}
function renderProgressPanel(activities, allDone) {
  if (!activities.length) return "";
  var doneClass = allDone ? " all-done" : "";
  var MAX_VISIBLE = 4;
  var hidden = 0;
  var visible = activities;
  if (allDone && activities.length > MAX_VISIBLE) {
    hidden = activities.length - MAX_VISIBLE;
    visible = activities.slice(-MAX_VISIBLE);
  } else if (!allDone && activities.length > MAX_VISIBLE + 1) {
    hidden = activities.length - MAX_VISIBLE - 1;
    visible = activities.slice(-MAX_VISIBLE - 1);
  }
  var lines = [];
  if (hidden > 0) {
    lines.push('<div class="ap-step"><span class="ap-mark" style="opacity:.3">â‹¯</span><span style="opacity:.4">' + hidden + ' ' + t("stepsCompleted") + '</span></div>');
  }
  visible.forEach(function(a, i) {
    var isLast = (i === visible.length - 1);
    var done = allDone || !isLast;
    var cls = done ? "ap-step" : "ap-step active";
    var mark = done ? '<span style="opacity:.4">âœ“</span>' : '<span class="ap-spin"></span>';
    var detail = a.detail ? '<span class="ap-detail">' + esc(a.detail) + '</span>' : "";
    lines.push('<div class="' + cls + '"><span class="ap-mark">' + mark + '</span><span>' + esc(a.label) + '</span>' + detail + '</div>');
  });
  return '<div class="agent-progress' + doneClass + '">' + lines.join("") + '</div>';
}
function showChatHelp() { document.getElementById("chatHelpPopup").classList.add("show"); document.getElementById("chatHelpOverlay").classList.add("show"); closeSB() }
function closeChatHelp() { document.getElementById("chatHelpPopup").classList.remove("show"); document.getElementById("chatHelpOverlay").classList.remove("show") }
document.addEventListener("click", function(e) { var mp = document.getElementById("modelPopup"), mb = document.getElementById("modelBtn"); if (!mp.contains(e.target) && !mb.contains(e.target)) mp.classList.remove("show") });

init();
</script>
</body>
</html>
