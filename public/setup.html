<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>EasyClaw â€” ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¦</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;450;500;600;700;800&family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&family=JetBrains+Mono:wght@300;400;500&family=Noto+Sans+JP:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
--black:#050505;--dark:#0a0a0a;--dark2:#111;--dark3:#1a1a1a;--dark4:#222;
--text:#e8e8e8;--text2:#888;--text3:#555;
--green:#00ff41;--green2:#00cc33;--greenDim:rgba(0,255,65,0.08);--greenGlow:rgba(0,255,65,0.15);
--accent:#e8562a;--accent2:#ff7040;
}
html{scroll-behavior:smooth}
body{font-family:'Inter','Noto Sans JP',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--black);color:var(--text);overflow-x:hidden;-webkit-font-smoothing:antialiased;min-height:100vh}
::selection{background:var(--greenGlow);color:var(--green)}

#matrix-bg{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;opacity:.06;pointer-events:none}

nav{position:fixed;top:0;left:0;right:0;z-index:100;padding:14px 24px;display:flex;align-items:center;justify-content:space-between;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);background:rgba(5,5,5,0.75);border-bottom:1px solid rgba(255,255,255,0.03)}
.nav-logo{font-size:16px;font-weight:600;display:flex;align-items:center;gap:8px;letter-spacing:-.3px;text-decoration:none;color:var(--text)}
.nav-user{font-size:12px;color:var(--text3);font-family:'JetBrains Mono',monospace}

.setup-container{position:relative;z-index:1;max-width:640px;margin:0 auto;padding:100px 20px 60px}

.setup-header{text-align:center;margin-bottom:40px;animation:fadeUp .6s ease}
.setup-header h1{font-family:'Playfair Display',serif;font-size:clamp(28px,5vw,40px);font-weight:600;letter-spacing:-1px;margin-bottom:12px}
.setup-header p{font-size:14px;color:var(--text2);font-weight:300;letter-spacing:.3px}

.step-indicator{display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:40px;animation:fadeUp .6s ease .1s both}
.step{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:600;font-family:'JetBrains Mono',monospace;border:1px solid rgba(255,255,255,0.1);color:var(--text3);transition:all .3s}
.step.active{background:var(--green);color:var(--black);border-color:var(--green);box-shadow:0 0 20px rgba(0,255,65,0.2)}
.step.done{background:rgba(0,255,65,0.1);color:var(--green);border-color:rgba(0,255,65,0.3)}
.step-line{width:40px;height:1px;background:rgba(255,255,255,0.08);transition:background .3s}
.step-line.done{background:rgba(0,255,65,0.3)}

.wizard-step{display:none;animation:fadeUp .4s ease}
.wizard-step.active{display:block}

.config-section{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:16px;padding:28px;margin-bottom:24px}
.config-title{font-size:11px;font-weight:500;color:var(--text2);letter-spacing:1.5px;text-transform:uppercase;font-family:'JetBrains Mono',monospace;margin-bottom:20px}

.form-group{margin-bottom:20px}
.form-label{display:block;font-size:11px;font-weight:500;color:var(--text2);margin-bottom:8px;letter-spacing:1px;text-transform:uppercase;font-family:'JetBrains Mono',monospace}
.form-input,.form-select{width:100%;padding:14px 18px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none;transition:border-color .2s}
.form-input:focus,.form-select:focus{border-color:rgba(0,255,65,0.3);box-shadow:0 0 0 3px rgba(0,255,65,0.05)}
.form-input::placeholder{color:var(--text3)}
.form-select{cursor:pointer;-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23888' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 16px center}
.form-select option{background:var(--dark2)}
.form-hint{font-size:11px;color:var(--text3);margin-top:8px;line-height:1.5}
.form-hint a{color:var(--green);text-decoration:none}

/* Check items */
.check-list{display:flex;flex-direction:column;gap:16px;margin-bottom:24px}
.check-item{display:flex;align-items:center;gap:16px;padding:18px 20px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:12px;transition:all .3s}
.check-item.ok{border-color:rgba(0,255,65,0.2);background:rgba(0,255,65,0.02)}
.check-item.fail{border-color:rgba(248,113,113,0.2);background:rgba(248,113,113,0.02)}
.check-icon{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06)}
.check-item.ok .check-icon{background:rgba(0,255,65,0.08);border-color:rgba(0,255,65,0.2);color:var(--green)}
.check-item.fail .check-icon{background:rgba(248,113,113,0.08);border-color:rgba(248,113,113,0.2);color:#F87171}
.check-info{flex:1}
.check-name{font-size:14px;font-weight:500;margin-bottom:4px}
.check-detail{font-size:11px;color:var(--text3);font-family:'JetBrains Mono',monospace}
.check-item.ok .check-detail{color:var(--green)}
.check-item.fail .check-detail{color:#F87171}
.check-help{font-size:11px;color:var(--text2);margin-top:6px;line-height:1.6}
.check-help code{font-family:'JetBrains Mono',monospace;font-size:11px;background:rgba(0,255,65,0.05);border:1px solid rgba(0,255,65,0.08);padding:1px 6px;border-radius:4px;color:var(--green)}
.check-help a{color:var(--green);text-decoration:none}
.check-help a:hover{text-decoration:underline}

.test-row{display:flex;align-items:center;gap:12px;margin-bottom:24px}
.test-btn{padding:10px 24px;border:1px solid rgba(255,255,255,0.1);border-radius:980px;background:transparent;color:var(--text2);font-size:13px;font-weight:500;cursor:pointer;font-family:inherit;transition:all .2s}
.test-btn:hover{border-color:var(--green);color:var(--green)}
.test-status{font-size:13px;font-family:'JetBrains Mono',monospace}
.test-status.ok{color:var(--green)}
.test-status.fail{color:#F87171}
.test-status.loading{color:var(--text3)}

/* Status indicator */
.status-box{text-align:center;padding:32px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:16px;margin-bottom:24px}
.status-icon{font-size:48px;margin-bottom:16px}
.status-text{font-size:16px;font-weight:500;margin-bottom:8px}
.status-detail{font-size:13px;color:var(--text2);line-height:1.6}

.btn-row{display:flex;gap:12px}
.btn-primary{flex:1;display:block;padding:18px;border:none;border-radius:980px;font-size:16px;font-weight:500;cursor:pointer;background:var(--accent);color:#fff;font-family:inherit;letter-spacing:.3px;transition:all .25s}
.btn-primary:hover{background:var(--accent2);transform:translateY(-2px);box-shadow:0 8px 30px rgba(232,86,42,0.3)}
.btn-primary:disabled{opacity:0.5;cursor:not-allowed;transform:none;box-shadow:none}
.btn-secondary{flex:1;display:block;padding:18px;border:1px solid rgba(255,255,255,0.1);border-radius:980px;font-size:16px;font-weight:500;cursor:pointer;background:transparent;color:var(--text2);font-family:inherit;letter-spacing:.3px;transition:all .25s}
.btn-secondary:hover{border-color:rgba(255,255,255,0.2);color:var(--text)}

.spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:spin .6s linear infinite;vertical-align:middle;margin-right:8px}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:none}}

/* Help popup */
.help-btn{display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:50%;background:rgba(0,255,65,0.08);border:1px solid rgba(0,255,65,0.15);color:var(--green);font-size:11px;font-weight:700;cursor:pointer;font-family:'JetBrains Mono',monospace;transition:all .2s;vertical-align:middle;margin-left:6px;flex-shrink:0}
.help-btn:hover{background:rgba(0,255,65,0.15);border-color:rgba(0,255,65,0.3);transform:scale(1.1)}
.help-popup{display:none;position:fixed;z-index:200;width:380px;max-width:90vw;background:var(--dark);border:1px solid rgba(0,255,65,0.15);border-radius:16px;padding:24px;box-shadow:0 16px 48px rgba(0,0,0,0.6);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);animation:fadeUp .2s ease;top:50%;left:50%;transform:translate(-50%,-50%)}
.help-popup.show{display:block}
.help-popup-title{font-size:14px;font-weight:600;color:var(--text);margin-bottom:10px;display:flex;align-items:center;gap:8px}
.help-popup-body{font-size:13px;color:var(--text2);line-height:1.8;margin-bottom:16px}
.help-popup-body code{font-family:'JetBrains Mono',monospace;font-size:12px;background:rgba(0,255,65,0.05);border:1px solid rgba(0,255,65,0.08);padding:1px 6px;border-radius:4px;color:var(--green)}
.help-popup-body ol,.help-popup-body ul{padding-left:18px;margin:8px 0}
.help-popup-body li{margin-bottom:4px}
.help-popup-link{display:inline-flex;align-items:center;gap:6px;padding:10px 18px;background:rgba(0,255,65,0.06);border:1px solid rgba(0,255,65,0.15);border-radius:980px;color:var(--green);font-size:12px;font-weight:500;text-decoration:none;transition:all .2s;font-family:'JetBrains Mono',monospace}
.help-popup-link:hover{background:rgba(0,255,65,0.12);border-color:rgba(0,255,65,0.3);transform:translateY(-1px)}
.help-popup-link+.help-popup-link{margin-left:8px}
.help-popup-close{position:absolute;top:12px;right:14px;background:none;border:none;color:var(--text3);cursor:pointer;font-size:18px;padding:4px;transition:color .2s}
.help-popup-close:hover{color:var(--text)}
.help-overlay{display:none;position:fixed;inset:0;z-index:199;background:rgba(0,0,0,0.4)}
.help-overlay.show{display:block}

@media(max-width:480px){
  .config-section{padding:20px}
  .btn-row{flex-direction:column}
}
</style>
</head>
<body>
<canvas id="matrix-bg"></canvas>
<nav>
  <a href="/" class="nav-logo"><span>ğŸ¦</span> EasyClaw</a>
  <span class="nav-user" id="navUser"></span>
</nav>

<div class="setup-container">
  <div class="setup-header">
    <h1>Setup</h1>
    <p>OpenClaw + Ollama ã®ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¾ã—ã‚‡ã†</p>
  </div>

  <div class="step-indicator">
    <div class="step active" id="stepDot1">1</div>
    <div class="step-line" id="stepLine1"></div>
    <div class="step" id="stepDot2">2</div>
    <div class="step-line" id="stepLine2"></div>
    <div class="step" id="stepDot3">3</div>
  </div>

  <!-- Step 1: Prerequisites Check -->
  <div class="wizard-step active" id="wizardStep1">
    <div class="config-section">
      <div class="config-title">ç’°å¢ƒãƒã‚§ãƒƒã‚¯</div>
      <div class="check-list" id="checkList">
        <div class="check-item" id="checkNode">
          <div class="check-icon">â³</div>
          <div class="check-info">
            <div class="check-name">Node.js (v22+)</div>
            <div class="check-detail">ç¢ºèªä¸­...</div>
          </div>
        </div>
        <div class="check-item" id="checkOllama">
          <div class="check-icon">â³</div>
          <div class="check-info">
            <div class="check-name">Ollama</div>
            <div class="check-detail">ç¢ºèªä¸­...</div>
          </div>
        </div>
        <div class="check-item" id="checkOpenclaw">
          <div class="check-icon">â³</div>
          <div class="check-info">
            <div class="check-name">OpenClaw CLI</div>
            <div class="check-detail">ç¢ºèªä¸­...</div>
          </div>
        </div>
      </div>
      <div class="test-row">
        <button class="test-btn" onclick="runPrereqCheck()">å†ãƒã‚§ãƒƒã‚¯</button>
        <span class="test-status" id="prereqStatus"></span>
      </div>
    </div>
    <div class="btn-row">
      <button class="btn-primary" id="step1Next" onclick="goToStep(2)" disabled>æ¬¡ã¸</button>
    </div>
  </div>

  <!-- Step 2: Ollama Model Setup -->
  <div class="wizard-step" id="wizardStep2">
    <div class="config-section">
      <div class="config-title">Ollama ãƒ¢ãƒ‡ãƒ«è¨­å®š <span class="help-btn" onclick="showHelp('ollama-setup')" title="ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ–¹æ³•">?</span></div>
      <div class="form-group">
        <label class="form-label">Ollama URL <span class="help-btn" onclick="showHelp('ollama-url')" title="URLã¨ã¯ï¼Ÿ">?</span></label>
        <input type="text" id="ollamaUrl" class="form-input" value="http://localhost:11434" placeholder="http://localhost:11434">
        <div class="form-hint">é€šå¸¸ã¯ã“ã®ã¾ã¾ã§OKã§ã™ã€‚å¤‰æ›´ä¸è¦ã€‚</div>
      </div>
      <div class="form-group">
        <label class="form-label">ãƒ¢ãƒ‡ãƒ« <span class="help-btn" onclick="showHelp('ollama-model')" title="ãƒ¢ãƒ‡ãƒ«ã¨ã¯ï¼Ÿ">?</span></label>
        <select id="ollamaModel" class="form-select">
          <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
        </select>
        <div class="form-hint">Ollamaã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã®ãƒ¢ãƒ‡ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br>ãƒ¢ãƒ‡ãƒ«ãŒãªã„å ´åˆ: <code>ollama pull llama3.2</code> ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</div>
      </div>
      <div class="test-row">
        <button class="test-btn" onclick="testOllamaConnection()">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
        <span class="test-status" id="ollamaTestStatus"></span>
      </div>
    </div>
    <div class="btn-row">
      <button class="btn-secondary" onclick="goToStep(1)">æˆ»ã‚‹</button>
      <button class="btn-primary" id="step2Next" onclick="goToStep(3)">æ¬¡ã¸</button>
    </div>
  </div>

  <!-- Step 3: OpenClaw Configuration -->
  <div class="wizard-step" id="wizardStep3">
    <div class="config-section">
      <div class="config-title">OpenClaw è‡ªå‹•è¨­å®š</div>
      <div class="status-box" id="configStatusBox">
        <div class="status-icon" id="configIcon">ğŸ”§</div>
        <div class="status-text" id="configText">OpenClawã‚’Ollamaã«æ¥ç¶šã™ã‚‹è¨­å®šã‚’ç”Ÿæˆã—ã¾ã™</div>
        <div class="status-detail" id="configDetail">é¸æŠã—ãŸOllama URLã¨ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã£ã¦ã€OpenClawã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•ä½œæˆã—ã¾ã™ã€‚</div>
      </div>
      <div style="text-align:center">
        <button class="test-btn" id="configureBtn" onclick="configureOpenClaw()">è¨­å®šã‚’ç”Ÿæˆã™ã‚‹</button>
      </div>
    </div>
    <div class="btn-row">
      <button class="btn-secondary" onclick="goToStep(2)">æˆ»ã‚‹</button>
      <button class="btn-primary" id="startChatBtn" onclick="finishSetup()" disabled>ãƒãƒ£ãƒƒãƒˆã‚’å§‹ã‚ã‚‹</button>
    </div>
  </div>
</div>

<!-- Help Popup -->
<div class="help-overlay" id="helpOverlay" onclick="closeHelp()"></div>
<div class="help-popup" id="helpPopup">
  <button class="help-popup-close" onclick="closeHelp()">&times;</button>
  <div id="helpContent"></div>
</div>

<script>
const HELP_DATA = {
  "ollama-setup": {
    title: "ğŸ“‹ Ollamaã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †",
    body: "<ol><li><a href='https://ollama.com/download' target='_blank' style='color:var(--green)'>ollama.com</a> ã‹ã‚‰Ollamaã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</li><li>ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã€OllamaãŒè‡ªå‹•ã§èµ·å‹•ã—ã¾ã™</li><li>ã‚³ãƒãƒ³ãƒ‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ä»¥ä¸‹ã‚’å®Ÿè¡Œï¼š<br><code>ollama pull llama3.2</code></li><li>ã“ã®ãƒšãƒ¼ã‚¸ã«æˆ»ã£ã¦ã€Œæ¥ç¶šãƒ†ã‚¹ãƒˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li></ol>",
    links: [{ text: "Ollamaãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰", url: "https://ollama.com/download" }, { text: "ãƒ¢ãƒ‡ãƒ«ä¸€è¦§", url: "https://ollama.com/library" }]
  },
  "ollama-url": {
    title: "ğŸ”— Ollama URLã¨ã¯ï¼Ÿ",
    body: "OllamaãŒPCä¸Šã§å‹•ä½œã™ã‚‹éš›ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã™ã€‚<br><br><strong>é€šå¸¸ã¯å¤‰æ›´ä¸è¦ã§ã™ã€‚</strong><br>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® <code>http://localhost:11434</code> ã®ã¾ã¾ãŠä½¿ã„ãã ã•ã„ã€‚",
    links: []
  },
  "ollama-model": {
    title: "ğŸ¤– ãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•",
    body: "AIãƒ¢ãƒ‡ãƒ«ã¯ã€Œé ­è„³ã€ã§ã™ã€‚<br><br><strong>æ‰‹é †ï¼š</strong><ol><li>ã‚³ãƒãƒ³ãƒ‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é–‹ã</li><li>ä»¥ä¸‹ã‚’å®Ÿè¡Œï¼š<br><code>ollama pull llama3.2</code></li><li>å®Œäº†å¾Œã€ã“ã®ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿</li></ol><br><strong>ãŠã™ã™ã‚ï¼š</strong><ul><li><code>llama3.2</code> â€” è»½é‡ãƒ»é«˜é€Ÿï¼ˆ2GBï¼‰</li><li><code>gemma2</code> â€” Googleè£½ï¼ˆ2Bï¼‰</li></ul>",
    links: [{ text: "ãƒ¢ãƒ‡ãƒ«ä¸€è¦§", url: "https://ollama.com/library" }]
  }
};

function showHelp(key) {
  const data = HELP_DATA[key];
  if (!data) return;
  let html = '<div class="help-popup-title">' + data.title + '</div>';
  html += '<div class="help-popup-body">' + data.body + '</div>';
  if (data.links && data.links.length > 0) {
    html += '<div>';
    data.links.forEach(function(link) {
      html += '<a class="help-popup-link" href="' + link.url + '" target="_blank">â†— ' + link.text + '</a> ';
    });
    html += '</div>';
  }
  document.getElementById("helpContent").innerHTML = html;
  document.getElementById("helpPopup").classList.add("show");
  document.getElementById("helpOverlay").classList.add("show");
}

function closeHelp() {
  document.getElementById("helpPopup").classList.remove("show");
  document.getElementById("helpOverlay").classList.remove("show");
}

// Auth
const token = localStorage.getItem("token");
const email = localStorage.getItem("email");
if (!token) location.href = "/app.html";
if (email) document.getElementById("navUser").textContent = email;

let currentStep = 1;
let prereqsOk = false;

// === Step Navigation ===
function goToStep(n) {
  currentStep = n;
  for (let i = 1; i <= 3; i++) {
    document.getElementById("wizardStep" + i).classList.toggle("active", i === n);
    const dot = document.getElementById("stepDot" + i);
    dot.className = "step" + (i < n ? " done" : i === n ? " active" : "");
    if (i < 3) {
      document.getElementById("stepLine" + i).className = "step-line" + (i < n ? " done" : "");
    }
  }
  if (n === 2) loadOllamaModels();
}

// === Step 1: Prerequisites ===
async function runPrereqCheck() {
  const statusEl = document.getElementById("prereqStatus");
  statusEl.className = "test-status loading";
  statusEl.textContent = "ãƒã‚§ãƒƒã‚¯ä¸­...";

  // Reset items
  ["checkNode", "checkOllama", "checkOpenclaw"].forEach(id => {
    const el = document.getElementById(id);
    el.className = "check-item";
    el.querySelector(".check-icon").textContent = "â³";
    el.querySelector(".check-detail").textContent = "ç¢ºèªä¸­...";
    const help = el.querySelector(".check-help");
    if (help) help.remove();
  });

  try {
    const res = await fetch("/api/prerequisites");
    const data = await res.json();

    // Node.js
    updateCheckItem("checkNode", data.node.ok, data.node.installed
      ? data.node.version + (data.node.ok ? "" : " (v22ä»¥ä¸ŠãŒå¿…è¦)")
      : "æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«",
      data.node.ok ? null : '<a href="https://nodejs.org/" target="_blank">Node.jså…¬å¼ã‚µã‚¤ãƒˆ</a> ã‹ã‚‰v22ä»¥ä¸Šã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚');

    // Ollama
    updateCheckItem("checkOllama", data.ollama.ok, data.ollama.installed
      ? data.ollama.version
      : "æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«",
      data.ollama.ok ? null : '<a href="https://ollama.com/download" target="_blank">Ollamaå…¬å¼ã‚µã‚¤ãƒˆ</a> ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚');

    // OpenClaw
    updateCheckItem("checkOpenclaw", data.openclaw.ok, data.openclaw.installed
      ? data.openclaw.version
      : "æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«",
      data.openclaw.ok ? null : 'ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œ: <code>npm install -g openclaw@latest</code>');

    prereqsOk = data.node.ok && data.ollama.ok && data.openclaw.ok;
    document.getElementById("step1Next").disabled = !prereqsOk;

    if (prereqsOk) {
      statusEl.className = "test-status ok";
      statusEl.textContent = "å…¨ã¦OK!";
    } else {
      statusEl.className = "test-status fail";
      statusEl.textContent = "æœªå¯¾å¿œã®é …ç›®ãŒã‚ã‚Šã¾ã™";
    }
  } catch(e) {
    statusEl.className = "test-status fail";
    statusEl.textContent = "ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ";
  }
}

function updateCheckItem(id, ok, detail, helpHtml) {
  const el = document.getElementById(id);
  el.className = "check-item " + (ok ? "ok" : "fail");
  el.querySelector(".check-icon").textContent = ok ? "âœ“" : "âœ—";
  el.querySelector(".check-detail").textContent = detail;
  const existing = el.querySelector(".check-help");
  if (existing) existing.remove();
  if (helpHtml) {
    const helpEl = document.createElement("div");
    helpEl.className = "check-help";
    helpEl.innerHTML = helpHtml;
    el.querySelector(".check-info").appendChild(helpEl);
  }
}

// === Step 2: Ollama Model ===
async function loadOllamaModels() {
  const sel = document.getElementById("ollamaModel");
  sel.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ä¸­...</option>';
  try {
    const res = await fetch("/api/ollama/models", { headers: { Authorization: "Bearer " + token } });
    const data = await res.json();
    if (data.success && data.models.length > 0) {
      sel.innerHTML = "";
      data.models.forEach(m => {
        const opt = document.createElement("option");
        const gb = m.size ? (m.size / (1024*1024*1024)).toFixed(1) + "GB" : "";
        opt.value = m.name;
        opt.textContent = m.name + (gb ? " (" + gb + ")" : "");
        sel.appendChild(opt);
      });
    } else {
      sel.innerHTML = '<option value="llama3.2">llama3.2 (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)</option>';
    }
  } catch(e) {
    sel.innerHTML = '<option value="llama3.2">llama3.2 (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)</option>';
  }
}

async function testOllamaConnection() {
  const statusEl = document.getElementById("ollamaTestStatus");
  statusEl.className = "test-status loading";
  statusEl.textContent = "æ¥ç¶šä¸­...";
  try {
    const res = await fetch("/api/ollama/health", { headers: { Authorization: "Bearer " + token } });
    const data = await res.json();
    if (data.ok) {
      statusEl.className = "test-status ok";
      statusEl.textContent = "æ¥ç¶šæˆåŠŸ!";
      loadOllamaModels();
    } else {
      statusEl.className = "test-status fail";
      statusEl.textContent = "æ¥ç¶šå¤±æ•— â€” OllamaãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“";
    }
  } catch(e) {
    statusEl.className = "test-status fail";
    statusEl.textContent = "æ¥ç¶šã‚¨ãƒ©ãƒ¼";
  }
}

// === Step 3: OpenClaw Configure ===
async function configureOpenClaw() {
  const btn = document.getElementById("configureBtn");
  btn.disabled = true;
  btn.textContent = "è¨­å®šä¸­...";
  document.getElementById("configIcon").textContent = "â³";
  document.getElementById("configText").textContent = "è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆä¸­...";

  try {
    const res = await fetch("/api/openclaw/configure", {
      method: "POST",
      headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
      body: JSON.stringify({
        ollamaUrl: document.getElementById("ollamaUrl").value.trim() || "http://localhost:11434",
        model: document.getElementById("ollamaModel").value || "llama3.2"
      })
    });
    const data = await res.json();
    if (data.success) {
      document.getElementById("configIcon").textContent = "âœ…";
      document.getElementById("configText").textContent = "è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸ";
      document.getElementById("configDetail").textContent = "è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«: " + data.configPath;
      document.getElementById("startChatBtn").disabled = false;
      btn.textContent = "è¨­å®šå®Œäº†";
    } else {
      throw new Error(data.error || "è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  } catch(e) {
    document.getElementById("configIcon").textContent = "âŒ";
    document.getElementById("configText").textContent = "è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ";
    document.getElementById("configDetail").textContent = e.message;
    btn.disabled = false;
    btn.textContent = "å†è©¦è¡Œ";
  }
}

// === Finish Setup ===
async function finishSetup() {
  const btn = document.getElementById("startChatBtn");
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>ä¿å­˜ä¸­...';

  try {
    const res = await fetch("/api/settings", {
      method: "POST",
      headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
      body: JSON.stringify({
        provider: "ollama",
        ollamaUrl: document.getElementById("ollamaUrl").value.trim() || "http://localhost:11434",
        model: document.getElementById("ollamaModel").value || "llama3.2"
      })
    });
    const data = await res.json();
    if (data.success) {
      // Restart gateway so new config takes effect
      try { await fetch("/api/openclaw/stop", { method: "POST", headers: { Authorization: "Bearer " + token } }); } catch(e) {}
      try { await fetch("/api/openclaw/start", { method: "POST", headers: { Authorization: "Bearer " + token } }); } catch(e) {}
      location.href = "/chat.html";
    } else {
      alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
      btn.disabled = false;
      btn.textContent = "ãƒãƒ£ãƒƒãƒˆã‚’å§‹ã‚ã‚‹";
    }
  } catch(e) {
    alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼");
    btn.disabled = false;
    btn.textContent = "ãƒãƒ£ãƒƒãƒˆã‚’å§‹ã‚ã‚‹";
  }
}

// Init
runPrereqCheck();

// Matrix rain
(function() {
  const c = document.getElementById("matrix-bg"), ctx = c.getContext("2d");
  function resize() { c.width = window.innerWidth; c.height = window.innerHeight; }
  resize(); window.addEventListener("resize", resize);
  const chars = "ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªã‚«ã‚­ã‚¯ã‚±ã‚³ã‚µã‚·ã‚¹ã‚»ã‚½ã‚¿ãƒãƒ„ãƒ†ãƒˆãƒŠãƒ‹ãƒŒãƒãƒ0123456789";
  const fontSize = 14, columns = Math.floor(window.innerWidth / fontSize);
  const drops = Array(columns).fill(1);
  function draw() {
    ctx.fillStyle = "rgba(5,5,5,0.15)";
    ctx.fillRect(0, 0, c.width, c.height);
    ctx.fillStyle = "#00ff41";
    ctx.font = fontSize + "px 'JetBrains Mono', monospace";
    for (let i = 0; i < drops.length; i++) {
      const text = chars[Math.floor(Math.random() * chars.length)];
      ctx.fillText(text, i * fontSize, drops[i] * fontSize);
      if (drops[i] * fontSize > c.height && Math.random() > 0.975) drops[i] = 0;
      drops[i]++;
    }
  }
  setInterval(draw, 50);
})();
</script>
</body>
</html>
